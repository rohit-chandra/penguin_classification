<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ml.school - Building Production Machine Learning Systems</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="ml.school - Building Production Machine Learning Systems">
<meta property="og:description" content="">
<meta property="og:image" content="https://svpino.github.io/ml.school/images/penguins.png">
<meta property="og:site-name" content="ml.school">
<meta property="og:image:height" content="1790">
<meta property="og:image:width" content="3000">
<meta name="twitter:title" content="ml.school - Building Production Machine Learning Systems">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://svpino.github.io/ml.school/images/penguins.png">
<meta name="twitter:image-height" content="1790">
<meta name="twitter:image-width" content="3000">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ml.school</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cohort.html">Building Production Machine Learning Systems</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Class Project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cohort.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Building Production Machine Learning Systems</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#initial-setup" id="toc-initial-setup" class="nav-link active" data-scroll-target="#initial-setup">Initial setup</a></li>
  <li><a href="#session-1---production-machine-learning-is-different" id="toc-session-1---production-machine-learning-is-different" class="nav-link" data-scroll-target="#session-1---production-machine-learning-is-different">Session 1 - Production Machine Learning is Different</a>
  <ul class="collapse">
  <li><a href="#step-1---exploratory-data-analysis" id="toc-step-1---exploratory-data-analysis" class="nav-link" data-scroll-target="#step-1---exploratory-data-analysis">Step 1 - Exploratory Data Analysis</a></li>
  <li><a href="#step-2---creating-the-preprocessing-script" id="toc-step-2---creating-the-preprocessing-script" class="nav-link" data-scroll-target="#step-2---creating-the-preprocessing-script">Step 2 - Creating the Preprocessing Script</a></li>
  <li><a href="#step-3---setting-up-the-processing-step" id="toc-step-3---setting-up-the-processing-step" class="nav-link" data-scroll-target="#step-3---setting-up-the-processing-step">Step 3 - Setting up the Processing Step</a></li>
  <li><a href="#step-4---creating-the-pipeline" id="toc-step-4---creating-the-pipeline" class="nav-link" data-scroll-target="#step-4---creating-the-pipeline">Step 4 - Creating the Pipeline</a></li>
  <li><a href="#assignments" id="toc-assignments" class="nav-link" data-scroll-target="#assignments">Assignments</a></li>
  </ul></li>
  <li><a href="#session-2---building-models-and-the-training-pipeline" id="toc-session-2---building-models-and-the-training-pipeline" class="nav-link" data-scroll-target="#session-2---building-models-and-the-training-pipeline">Session 2 - Building Models And The Training Pipeline</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-training-script" id="toc-step-1---creating-the-training-script" class="nav-link" data-scroll-target="#step-1---creating-the-training-script">Step 1 - Creating the Training Script</a></li>
  <li><a href="#step-2---setting-up-the-training-step" id="toc-step-2---setting-up-the-training-step" class="nav-link" data-scroll-target="#step-2---setting-up-the-training-step">Step 2 - Setting up the Training Step</a></li>
  <li><a href="#step-3---setting-up-a-tuning-step" id="toc-step-3---setting-up-a-tuning-step" class="nav-link" data-scroll-target="#step-3---setting-up-a-tuning-step">Step 3 - Setting up a Tuning Step</a></li>
  <li><a href="#step-4---creating-the-pipeline-1" id="toc-step-4---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-4---creating-the-pipeline-1">Step 4 - Creating the Pipeline</a></li>
  <li><a href="#assignments-1" id="toc-assignments-1" class="nav-link" data-scroll-target="#assignments-1">Assignments</a></li>
  </ul></li>
  <li><a href="#session-3---evaluating-and-versioning-models" id="toc-session-3---evaluating-and-versioning-models" class="nav-link" data-scroll-target="#session-3---evaluating-and-versioning-models">Session 3 - Evaluating and Versioning Models</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-evaluation-script" id="toc-step-1---creating-the-evaluation-script" class="nav-link" data-scroll-target="#step-1---creating-the-evaluation-script">Step 1 - Creating the Evaluation Script</a></li>
  <li><a href="#step-2---setting-up-the-evaluation-step" id="toc-step-2---setting-up-the-evaluation-step" class="nav-link" data-scroll-target="#step-2---setting-up-the-evaluation-step">Step 2 - Setting up the Evaluation Step</a></li>
  <li><a href="#step-3---registering-the-model" id="toc-step-3---registering-the-model" class="nav-link" data-scroll-target="#step-3---registering-the-model">Step 3 - Registering the Model</a></li>
  <li><a href="#step-4---setting-up-a-condition-step" id="toc-step-4---setting-up-a-condition-step" class="nav-link" data-scroll-target="#step-4---setting-up-a-condition-step">Step 4 - Setting up a Condition Step</a></li>
  <li><a href="#step-5---creating-the-pipeline" id="toc-step-5---creating-the-pipeline" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline">Step 5 - Creating the Pipeline</a></li>
  <li><a href="#assignments-2" id="toc-assignments-2" class="nav-link" data-scroll-target="#assignments-2">Assignments</a></li>
  </ul></li>
  <li><a href="#session-4---deploying-models-and-serving-predictions" id="toc-session-4---deploying-models-and-serving-predictions" class="nav-link" data-scroll-target="#session-4---deploying-models-and-serving-predictions">Session 4 - Deploying Models and Serving Predictions</a>
  <ul class="collapse">
  <li><a href="#step-1---deploying-model-from-registry" id="toc-step-1---deploying-model-from-registry" class="nav-link" data-scroll-target="#step-1---deploying-model-from-registry">Step 1 - Deploying Model From Registry</a></li>
  <li><a href="#step-2---creating-the-preprocessing-script-1" id="toc-step-2---creating-the-preprocessing-script-1" class="nav-link" data-scroll-target="#step-2---creating-the-preprocessing-script-1">Step 2 - Creating the Preprocessing Script</a></li>
  <li><a href="#step-3---creating-the-postprocessing-script" id="toc-step-3---creating-the-postprocessing-script" class="nav-link" data-scroll-target="#step-3---creating-the-postprocessing-script">Step 3 - Creating the Postprocessing Script</a></li>
  <li><a href="#step-4---setting-up-the-inference-pipeline" id="toc-step-4---setting-up-the-inference-pipeline" class="nav-link" data-scroll-target="#step-4---setting-up-the-inference-pipeline">Step 4 - Setting up the Inference Pipeline</a></li>
  <li><a href="#step-5---registering-the-model" id="toc-step-5---registering-the-model" class="nav-link" data-scroll-target="#step-5---registering-the-model">Step 5 - Registering the Model</a></li>
  <li><a href="#step-6---modifying-the-condition-step" id="toc-step-6---modifying-the-condition-step" class="nav-link" data-scroll-target="#step-6---modifying-the-condition-step">Step 6 - Modifying the Condition Step</a></li>
  <li><a href="#step-7---creating-the-pipeline" id="toc-step-7---creating-the-pipeline" class="nav-link" data-scroll-target="#step-7---creating-the-pipeline">Step 7 - Creating the Pipeline</a></li>
  <li><a href="#step-8---creating-the-lambda-function" id="toc-step-8---creating-the-lambda-function" class="nav-link" data-scroll-target="#step-8---creating-the-lambda-function">Step 8 - Creating the Lambda Function</a></li>
  <li><a href="#step-9---setting-up-eventbridge" id="toc-step-9---setting-up-eventbridge" class="nav-link" data-scroll-target="#step-9---setting-up-eventbridge">Step 9 - Setting Up EventBridge</a></li>
  <li><a href="#step-10---testing-the-endpoint" id="toc-step-10---testing-the-endpoint" class="nav-link" data-scroll-target="#step-10---testing-the-endpoint">Step 10 - Testing the Endpoint</a></li>
  <li><a href="#assignments-3" id="toc-assignments-3" class="nav-link" data-scroll-target="#assignments-3">Assignments</a></li>
  </ul></li>
  <li><a href="#session-5---data-distribution-shifts-and-model-monitoring" id="toc-session-5---data-distribution-shifts-and-model-monitoring" class="nav-link" data-scroll-target="#session-5---data-distribution-shifts-and-model-monitoring">Session 5 - Data Distribution Shifts And Model Monitoring</a>
  <ul class="collapse">
  <li><a href="#step-1---generating-data-quality-baseline" id="toc-step-1---generating-data-quality-baseline" class="nav-link" data-scroll-target="#step-1---generating-data-quality-baseline">Step 1 - Generating Data Quality Baseline</a></li>
  <li><a href="#step-2---generating-test-predictions" id="toc-step-2---generating-test-predictions" class="nav-link" data-scroll-target="#step-2---generating-test-predictions">Step 2 - Generating Test Predictions</a></li>
  <li><a href="#step-3---generating-model-quality-baseline" id="toc-step-3---generating-model-quality-baseline" class="nav-link" data-scroll-target="#step-3---generating-model-quality-baseline">Step 3 - Generating Model Quality Baseline</a></li>
  <li><a href="#step-4---setting-up-model-metrics" id="toc-step-4---setting-up-model-metrics" class="nav-link" data-scroll-target="#step-4---setting-up-model-metrics">Step 4 - Setting up Model Metrics</a></li>
  <li><a href="#step-5---modifying-the-registration-step" id="toc-step-5---modifying-the-registration-step" class="nav-link" data-scroll-target="#step-5---modifying-the-registration-step">Step 5 - Modifying the Registration Step</a></li>
  <li><a href="#step-6---modifying-the-condition-step-1" id="toc-step-6---modifying-the-condition-step-1" class="nav-link" data-scroll-target="#step-6---modifying-the-condition-step-1">Step 6 - Modifying the Condition Step</a></li>
  <li><a href="#step-7---creating-the-pipeline-1" id="toc-step-7---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-7---creating-the-pipeline-1">Step 7 - Creating the Pipeline</a></li>
  <li><a href="#step-8---checking-constraints-and-statistics" id="toc-step-8---checking-constraints-and-statistics" class="nav-link" data-scroll-target="#step-8---checking-constraints-and-statistics">Step 8 - Checking Constraints and Statistics</a></li>
  <li><a href="#step-9---generating-fake-traffic" id="toc-step-9---generating-fake-traffic" class="nav-link" data-scroll-target="#step-9---generating-fake-traffic">Step 9 - Generating Fake Traffic</a></li>
  <li><a href="#step-10---generating-fake-labels" id="toc-step-10---generating-fake-labels" class="nav-link" data-scroll-target="#step-10---generating-fake-labels">Step 10 - Generating Fake Labels</a></li>
  <li><a href="#step-11---preparing-monitoring-functions" id="toc-step-11---preparing-monitoring-functions" class="nav-link" data-scroll-target="#step-11---preparing-monitoring-functions">Step 11 - Preparing Monitoring Functions</a></li>
  <li><a href="#step-12---setting-up-data-monitoring-job" id="toc-step-12---setting-up-data-monitoring-job" class="nav-link" data-scroll-target="#step-12---setting-up-data-monitoring-job">Step 12 - Setting Up Data Monitoring Job</a></li>
  <li><a href="#step-13---setting-up-model-monitoring-job" id="toc-step-13---setting-up-model-monitoring-job" class="nav-link" data-scroll-target="#step-13---setting-up-model-monitoring-job">Step 13 - Setting up Model Monitoring Job</a></li>
  <li><a href="#step-14---tearing-down-resources" id="toc-step-14---tearing-down-resources" class="nav-link" data-scroll-target="#step-14---tearing-down-resources">Step 14 - Tearing Down Resources</a></li>
  <li><a href="#assignments-4" id="toc-assignments-4" class="nav-link" data-scroll-target="#assignments-4">Assignments</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/svpino/ml.school/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building Production Machine Learning Systems</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This notebook creates a <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_building_pipeline.html">SageMaker Pipeline</a> to build an end-to-end Machine Learning system to solve the problem of classifying penguin species. With a SageMaker Pipeline, you can create, automate, and manage end-to-end Machine Learning workflows at scale.</p>
<p>You can find more information about Amazon SageMaker in the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html">Amazon SageMaker Developer Guide</a>. The <a href="https://aws.amazon.com/blogs/machine-learning/">AWS Machine Learning Blog</a> is an excellent source to stay up-to-date with SageMaker.</p>
<p>This example uses the <a href="https://www.kaggle.com/parulpandey/palmer-archipelago-antarctica-penguin-data">Penguins dataset</a>, the <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html">boto3</a> library, and the <a href="https://sagemaker.readthedocs.io/en/stable/">SageMaker Python SDK</a>.</p>
<p><img src="images/penguins.png" alt="Penguins" width="800"></p>
<p>This notebook is part of the <a href="https://www.ml.school">Machine Learning School</a> program.</p>
<section id="initial-setup" class="level2">
<h2 class="anchored" data-anchor-id="initial-setup">Initial setup</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before running this notebook, follow the <a href="https://program.ml.school/setup.html">Setup Instructions</a> for the program.</p>
</div>
</div>
<p>Let’s start by setting up the environment and preparing to run the notebook.</p>
<p>We can run this notebook in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-local-mode.html">Local Mode</a> to test the pipeline in your local environment before using SageMaker. You can run the code in Local Mode by setting the <code>LOCAL_MODE</code> constant to <code>True</code>.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>LOCAL_MODE <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s load the S3 bucket name and the AWS Role from the environment variables:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> os.environ[<span class="st">"BUCKET"</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>S3_LOCATION <span class="op">=</span> <span class="ss">f"s3://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you are running the pipeline in Local Mode on an ARM64 machine, you will need to use a custom Docker image to train and evaluate the model. This is because SageMaker doesn’t provide a TensorFlow image that supports Apple’s M chips.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>architecture <span class="op">=</span> <span class="op">!</span>(uname <span class="op">-</span>m)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>IS_APPLE_M_CHIP <span class="op">=</span> architecture[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"arm64"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create a configuration dictionary with different settings depending on whether we are running the pipeline in Local Mode or not:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_context <span class="im">import</span> PipelineSession, LocalPipelineSession</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>pipeline_session <span class="op">=</span> PipelineSession(default_bucket<span class="op">=</span>bucket) <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> LOCAL_MODE:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: LocalPipelineSession(default_bucket<span class="op">=</span>bucket),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"local"</span>, <span class="co"># specify the compute power we need based on the job we are running</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to use a custom Docker image when we run the pipeline</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in Local Model on an ARM64 machine.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: <span class="st">"sagemaker-tensorflow-toolkit-local"</span> <span class="cf">if</span> IS_APPLE_M_CHIP <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: pipeline_session,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"ml.m5.xlarge"</span>, <span class="co"># can be changed as per the need</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: <span class="va">None</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"framework_version"</span>] <span class="op">=</span> <span class="st">"2.11"</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"py_version"</span>] <span class="op">=</span> <span class="st">"py39"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Windows Support for Local Mode is Experimental</code></pre>
</div>
</div>
<p>Let’s now initialize a few variables that we’ll need throughout the notebook:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boto3 is AWS's API that helps us to access anything on AWS</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>sagemaker_session <span class="op">=</span> sagemaker.session.Session()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># access sagemaker client</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>sagemaker_client <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># authentication and authorization for AWS services</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>iam_client <span class="op">=</span> boto3.client(<span class="st">"iam"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> boto3.Session().region_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="session-1---production-machine-learning-is-different" class="level2">
<h2 class="anchored" data-anchor-id="session-1---production-machine-learning-is-different">Session 1 - Production Machine Learning is Different</h2>
<p>In this session we’ll run Exploratory Data Analysis on the <a href="https://www.kaggle.com/parulpandey/palmer-archipelago-antarctica-penguin-data">Penguins dataset</a> and we’ll build a simple <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with one step to split and transform the data.</p>
<p><a href="images/training.png" target="_blank"> <img src="images/training.png" alt="Training" style="max-width: 750px;"></a></p>
<p>We’ll use a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">Scikit-Learn Pipeline</a> for the transformations, and a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> with a <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor">SKLearnProcessor</a> to execute a preprocessing script. Check the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipelines Overview</a> for an introduction to the fundamental components of a SageMaker Pipeline.</p>
<section id="step-1---exploratory-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="step-1---exploratory-data-analysis">Step 1 - Exploratory Data Analysis</h3>
<p>Let’s run Exploratory Data Analysis on the dataset. The goal of this section is to understand the data and the problem we are trying to solve.</p>
<p>Let’s load the Penguins dataset:</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>penguins <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>penguins.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.1</td>
<td>18.7</td>
<td>181.0</td>
<td>3750.0</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.5</td>
<td>17.4</td>
<td>186.0</td>
<td>3800.0</td>
<td>FEMALE</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>40.3</td>
<td>18.0</td>
<td>195.0</td>
<td>3250.0</td>
<td>FEMALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>36.7</td>
<td>19.3</td>
<td>193.0</td>
<td>3450.0</td>
<td>FEMALE</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see the dataset contains the following columns:</p>
<ol type="1">
<li><code>species</code>: The species of a penguin. This is the column we want to predict.</li>
<li><code>island</code>: The island where the penguin was found</li>
<li><code>culmen_length_mm</code>: The length of the penguin’s culmen (bill) in millimeters</li>
<li><code>culmen_depth_mm</code>: The depth of the penguin’s culmen in millimeters</li>
<li><code>flipper_length_mm</code>: The length of the penguin’s flipper in millimeters</li>
<li><code>body_mass_g</code>: The body mass of the penguin in grams</li>
<li><code>sex</code>: The sex of the penguin</li>
</ol>
<p>If you are curious, here is the description of a penguin’s culmen:</p>
<p><img src="images/culmen.jpeg" alt="Culmen" width="600"></p>
<p>Now, let’s get the summary statistics for the features in our dataset.</p>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>penguins.describe(include<span class="op">=</span><span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>344</td>
<td>344</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>334</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>3</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>Adelie</td>
<td>Biscoe</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>152</td>
<td>168</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>NaN</td>
<td>NaN</td>
<td>43.921930</td>
<td>17.151170</td>
<td>200.915205</td>
<td>4201.754386</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>NaN</td>
<td>NaN</td>
<td>5.459584</td>
<td>1.974793</td>
<td>14.061714</td>
<td>801.954536</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>NaN</td>
<td>NaN</td>
<td>32.100000</td>
<td>13.100000</td>
<td>172.000000</td>
<td>2700.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>NaN</td>
<td>NaN</td>
<td>39.225000</td>
<td>15.600000</td>
<td>190.000000</td>
<td>3550.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>NaN</td>
<td>NaN</td>
<td>44.450000</td>
<td>17.300000</td>
<td>197.000000</td>
<td>4050.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>NaN</td>
<td>NaN</td>
<td>48.500000</td>
<td>18.700000</td>
<td>213.000000</td>
<td>4750.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>NaN</td>
<td>NaN</td>
<td>59.600000</td>
<td>21.500000</td>
<td>231.000000</td>
<td>6300.000000</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s now display the distribution of values for the three categorical columns in our data:</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>species_distribution <span class="op">=</span> penguins[<span class="st">"species"</span>].value_counts()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>island_distribution <span class="op">=</span> penguins[<span class="st">"island"</span>].value_counts()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>sex_distribution <span class="op">=</span> penguins[<span class="st">"sex"</span>].value_counts()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(species_distribution)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(island_distribution)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sex_distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Adelie       152
Gentoo       124
Chinstrap     68
Name: species, dtype: int64

Biscoe       168
Dream        124
Torgersen     52
Name: island, dtype: int64

MALE      168
FEMALE    165
.           1
Name: sex, dtype: int64</code></pre>
</div>
</div>
<p>The distribution of the categories in our data are:</p>
<ul>
<li><code>species</code>: There are 3 species of penguins in the dataset: Adelie (152), Gentoo (124), and Chinstrap (68).</li>
<li><code>island</code>: Penguins are from 3 islands: Biscoe (168), Dream (124), and Torgersen (52).</li>
<li><code>sex</code>: We have 168 male penguins, 165 female penguins, and 1 penguin with an ambiguous gender (<code>.</code>).</li>
</ul>
<p>Let’s replace the ambiguous value in the <code>sex</code> column with a null value:</p>
<div class="cell" data-tags="[]" data-execution_count="197">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>penguins[<span class="st">"sex"</span>] <span class="op">=</span> penguins[<span class="st">"sex"</span>].replace(<span class="st">"."</span>, np.nan)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sex_distribution <span class="op">=</span> penguins[<span class="st">"sex"</span>].value_counts()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sex_distribution</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="197">
<pre><code>sex
MALE      168
FEMALE    165
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>Next, let’s check for any missing values in the dataset.</p>
<div class="cell" data-tags="[]" data-execution_count="198">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>penguins.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="198">
<pre><code>species               0
island                0
culmen_length_mm      2
culmen_depth_mm       2
flipper_length_mm     2
body_mass_g           2
sex                  11
dtype: int64</code></pre>
</div>
</div>
<p>Let’s get rid of the missing values. For now, we are going to replace the missing values with the most frequent value in the column. Later, we’ll use a different strategy to replace missing numeric values.</p>
<div class="cell" data-tags="[]" data-execution_count="199">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>penguins.iloc[:, :] <span class="op">=</span> imputer.fit_transform(penguins)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>penguins.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="199">
<pre><code>species              0
island               0
culmen_length_mm     0
culmen_depth_mm      0
flipper_length_mm    0
body_mass_g          0
sex                  0
dtype: int64</code></pre>
</div>
</div>
<p>Let’s visualize the distribution of categorical features.</p>
<div class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">10</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].bar(species_distribution.index, species_distribution.values)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Distribution of Species"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].bar(island_distribution.index, island_distribution.values)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"Distribution of Island"</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].bar(sex_distribution.index, sex_distribution.values)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">"Distribution of Sex"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="cohort_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s visualize the distribution of numerical columns.</p>
<div class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].hist(penguins[<span class="st">"culmen_length_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of culmen_length_mm"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].hist(penguins[<span class="st">"culmen_depth_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">"Distribution of culmen_depth_mm"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].hist(penguins[<span class="st">"flipper_length_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of flipper_length_mm"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].hist(penguins[<span class="st">"body_mass_g"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">"Distribution of body_mass_g"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="cohort_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s display the covariance matrix of the dataset. The “covariance” measures how changes in one variable are associated with changes in a second variable. In other words, the covariance measures the degree to which two variables are linearly associated.</p>
<div class="cell" data-tags="[]" data-execution_count="202">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>penguins.cov(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="202">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>29.679415</td>
<td>-2.516984</td>
<td>50.260588</td>
<td>2596.971151</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-2.516984</td>
<td>3.877201</td>
<td>-16.108849</td>
<td>-742.660180</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>50.260588</td>
<td>-16.108849</td>
<td>197.269501</td>
<td>9792.552037</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>2596.971151</td>
<td>-742.660180</td>
<td>9792.552037</td>
<td>640316.716388</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here are three examples of what we get from interpreting the covariance matrix below:</p>
<ol type="1">
<li>Penguins that weight more tend to have a larger culmen.</li>
<li>The more a penguin weights, the shallower its culmen tends to be.</li>
<li>There’s a small variance between the culmen depth of penguins.</li>
</ol>
<p>Let’s now display the correlation matrix. “Correlation” measures both the strength and direction of the linear relationship between two variables.</p>
<div class="cell" data-tags="[]" data-execution_count="203">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>penguins.corr(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="203">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>1.000000</td>
<td>-0.234635</td>
<td>0.656856</td>
<td>0.595720</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-0.234635</td>
<td>1.000000</td>
<td>-0.582472</td>
<td>-0.471339</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>0.656856</td>
<td>-0.582472</td>
<td>1.000000</td>
<td>0.871302</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>0.595720</td>
<td>-0.471339</td>
<td>0.871302</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here are three examples of what we get from interpreting the correlation matrix below:</p>
<ol type="1">
<li>Penguins that weight more tend to have larger flippers.</li>
<li>Penguins with a shallower culmen tend to have larger flippers.</li>
<li>The length and depth of the culmen have a slight negative correlation.</li>
</ol>
<p>Let’s display the distribution of species by island.</p>
<div class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>unique_species <span class="op">=</span> penguins[<span class="st">"species"</span>].unique()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> species <span class="kw">in</span> unique_species:</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> penguins[penguins[<span class="st">"species"</span>] <span class="op">==</span> species]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    ax.hist(data[<span class="st">"island"</span>], bins<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>species)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Island"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distribution of Species by Island"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="cohort_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s display the distribution of species by sex.</p>
<div class="cell" data-tags="[]" data-execution_count="205">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> species <span class="kw">in</span> unique_species:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> penguins[penguins[<span class="st">"species"</span>] <span class="op">==</span> species]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    ax.hist(data[<span class="st">"sex"</span>], bins<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>species)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Sex"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distribution of Species by Sex"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="cohort_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="step-2---creating-the-preprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-preprocessing-script">Step 2 - Creating the Preprocessing Script</h3>
<p>Here’s a high-level overview of the preprocessing step and the Processing Job that SageMaker creates behind the scenes:</p>
<p><a href="images/preprocess-data.png" target="_blank"> <img src="images/preprocess-data.png" alt="High-level overview of the Preprocessing Data Step and SageMaker’s Processing Jobs" style="max-width: 750px;"></a></p>
<p>The first step we need in the pipeline is a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to run a script that will split and transform the data. This Processing Step will create a SageMaker Processing Job in the background, run the script, and upload the output to S3. You can use Processing Jobs to perform data preprocessing, post-processing, feature engineering, data validation, and model evaluation. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>The first step is to create the script that will split and transform the input data.</p>
<div id="preprocessing-script" class="cell" data-tags="[]" data-execution_count="206">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>preprocessor.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="im">import</span> os</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="im">import</span> tarfile</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="im">import</span> tempfile</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="im">import</span> joblib</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-7"><a href="#cb23-7"></a></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer, make_column_selector</span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, StandardScaler, OrdinalEncoder</span>
<span id="cb23-14"><a href="#cb23-14"></a></span>
<span id="cb23-15"><a href="#cb23-15"></a></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="kw">def</span> preprocess(base_directory):</span>
<span id="cb23-17"><a href="#cb23-17"></a>    <span class="co">"""</span></span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="co">    This function loads the supplied data, splits it and transforms it.</span></span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="co">    """</span></span>
<span id="cb23-20"><a href="#cb23-20"></a></span>
<span id="cb23-21"><a href="#cb23-21"></a>    df <span class="op">=</span> _read_data_from_input_csv_files(base_directory)</span>
<span id="cb23-22"><a href="#cb23-22"></a>    </span>
<span id="cb23-23"><a href="#cb23-23"></a>    target_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb23-24"><a href="#cb23-24"></a>        transformers<span class="op">=</span>[(<span class="st">"species"</span>, OrdinalEncoder(), [<span class="dv">0</span>])]</span>
<span id="cb23-25"><a href="#cb23-25"></a>    )</span>
<span id="cb23-26"><a href="#cb23-26"></a>    </span>
<span id="cb23-27"><a href="#cb23-27"></a>    numeric_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb23-28"><a href="#cb23-28"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"mean"</span>),</span>
<span id="cb23-29"><a href="#cb23-29"></a>        StandardScaler()</span>
<span id="cb23-30"><a href="#cb23-30"></a>    )</span>
<span id="cb23-31"><a href="#cb23-31"></a></span>
<span id="cb23-32"><a href="#cb23-32"></a>    categorical_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb23-33"><a href="#cb23-33"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>),</span>
<span id="cb23-34"><a href="#cb23-34"></a>        OneHotEncoder()</span>
<span id="cb23-35"><a href="#cb23-35"></a>    )</span>
<span id="cb23-36"><a href="#cb23-36"></a>    </span>
<span id="cb23-37"><a href="#cb23-37"></a>    features_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb23-38"><a href="#cb23-38"></a>        transformers<span class="op">=</span>[</span>
<span id="cb23-39"><a href="#cb23-39"></a>            (<span class="st">"numeric"</span>, numeric_transformer, make_column_selector(dtype_exclude<span class="op">=</span><span class="st">"object"</span>)),</span>
<span id="cb23-40"><a href="#cb23-40"></a>            (<span class="st">"categorical"</span>, categorical_transformer, [<span class="st">"island"</span>]),</span>
<span id="cb23-41"><a href="#cb23-41"></a>        ]</span>
<span id="cb23-42"><a href="#cb23-42"></a>    )</span>
<span id="cb23-43"><a href="#cb23-43"></a></span>
<span id="cb23-44"><a href="#cb23-44"></a>    df_train, df_validation, df_test <span class="op">=</span> _split_data(df)</span>
<span id="cb23-45"><a href="#cb23-45"></a></span>
<span id="cb23-46"><a href="#cb23-46"></a>    _save_baselines(base_directory, df_train, df_test)</span>
<span id="cb23-47"><a href="#cb23-47"></a></span>
<span id="cb23-48"><a href="#cb23-48"></a>    y_train <span class="op">=</span> target_transformer.fit_transform(np.array(df_train.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb23-49"><a href="#cb23-49"></a>    y_validation <span class="op">=</span> target_transformer.transform(np.array(df_validation.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb23-50"><a href="#cb23-50"></a>    y_test <span class="op">=</span> target_transformer.transform(np.array(df_test.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb23-51"><a href="#cb23-51"></a>    </span>
<span id="cb23-52"><a href="#cb23-52"></a>    df_train <span class="op">=</span> df_train.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-53"><a href="#cb23-53"></a>    df_validation <span class="op">=</span> df_validation.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-54"><a href="#cb23-54"></a>    df_test <span class="op">=</span> df_test.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-55"><a href="#cb23-55"></a></span>
<span id="cb23-56"><a href="#cb23-56"></a>    X_train <span class="op">=</span> features_transformer.fit_transform(df_train)</span>
<span id="cb23-57"><a href="#cb23-57"></a>    X_validation <span class="op">=</span> features_transformer.transform(df_validation)</span>
<span id="cb23-58"><a href="#cb23-58"></a>    X_test <span class="op">=</span> features_transformer.transform(df_test)</span>
<span id="cb23-59"><a href="#cb23-59"></a></span>
<span id="cb23-60"><a href="#cb23-60"></a>    _save_splits(base_directory, X_train, y_train, X_validation, y_validation, X_test, y_test)</span>
<span id="cb23-61"><a href="#cb23-61"></a>    _save_model(base_directory, target_transformer, features_transformer)</span>
<span id="cb23-62"><a href="#cb23-62"></a>    </span>
<span id="cb23-63"><a href="#cb23-63"></a></span>
<span id="cb23-64"><a href="#cb23-64"></a><span class="kw">def</span> _read_data_from_input_csv_files(base_directory):</span>
<span id="cb23-65"><a href="#cb23-65"></a>    <span class="co">"""</span></span>
<span id="cb23-66"><a href="#cb23-66"></a><span class="co">    This function reads every CSV file available and concatenates</span></span>
<span id="cb23-67"><a href="#cb23-67"></a><span class="co">    them into a single dataframe.</span></span>
<span id="cb23-68"><a href="#cb23-68"></a><span class="co">    """</span></span>
<span id="cb23-69"><a href="#cb23-69"></a></span>
<span id="cb23-70"><a href="#cb23-70"></a>    input_directory <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb23-71"><a href="#cb23-71"></a>    files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> input_directory.glob(<span class="st">"*.csv"</span>)]</span>
<span id="cb23-72"><a href="#cb23-72"></a>    </span>
<span id="cb23-73"><a href="#cb23-73"></a>    <span class="cf">if</span> <span class="bu">len</span>(files) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-74"><a href="#cb23-74"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"The are no CSV files in </span><span class="sc">{</span><span class="bu">str</span>(input_directory)<span class="sc">}</span><span class="ss">/"</span>)</span>
<span id="cb23-75"><a href="#cb23-75"></a>        </span>
<span id="cb23-76"><a href="#cb23-76"></a>    raw_data <span class="op">=</span> [pd.read_csv(<span class="bu">file</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files]</span>
<span id="cb23-77"><a href="#cb23-77"></a>    df <span class="op">=</span> pd.concat(raw_data)</span>
<span id="cb23-78"><a href="#cb23-78"></a>    </span>
<span id="cb23-79"><a href="#cb23-79"></a>    <span class="co"># Shuffle the data</span></span>
<span id="cb23-80"><a href="#cb23-80"></a>    <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-81"><a href="#cb23-81"></a></span>
<span id="cb23-82"><a href="#cb23-82"></a></span>
<span id="cb23-83"><a href="#cb23-83"></a><span class="kw">def</span> _split_data(df):</span>
<span id="cb23-84"><a href="#cb23-84"></a>    <span class="co">"""</span></span>
<span id="cb23-85"><a href="#cb23-85"></a><span class="co">    Splits the data into three sets: train, validation and test.</span></span>
<span id="cb23-86"><a href="#cb23-86"></a><span class="co">    """</span></span>
<span id="cb23-87"><a href="#cb23-87"></a></span>
<span id="cb23-88"><a href="#cb23-88"></a>    df_train, temp <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb23-89"><a href="#cb23-89"></a>    df_validation, df_test <span class="op">=</span> train_test_split(temp, test_size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-90"><a href="#cb23-90"></a></span>
<span id="cb23-91"><a href="#cb23-91"></a>    <span class="cf">return</span> df_train, df_validation, df_test</span>
<span id="cb23-92"><a href="#cb23-92"></a></span>
<span id="cb23-93"><a href="#cb23-93"></a></span>
<span id="cb23-94"><a href="#cb23-94"></a><span class="kw">def</span> _save_baselines(base_directory, df_train, df_test):</span>
<span id="cb23-95"><a href="#cb23-95"></a>    <span class="co">"""</span></span>
<span id="cb23-96"><a href="#cb23-96"></a><span class="co">    During the data and quality monitoring steps, we will need baselines</span></span>
<span id="cb23-97"><a href="#cb23-97"></a><span class="co">    to compute constraints and statistics. This function saves the </span></span>
<span id="cb23-98"><a href="#cb23-98"></a><span class="co">    untransformed data to disk so we can use them as baselines later.</span></span>
<span id="cb23-99"><a href="#cb23-99"></a><span class="co">    """</span></span>
<span id="cb23-100"><a href="#cb23-100"></a></span>
<span id="cb23-101"><a href="#cb23-101"></a>    <span class="cf">for</span> split, data <span class="kw">in</span> [(<span class="st">"train"</span>, df_train), (<span class="st">"test"</span>, df_test)]:</span>
<span id="cb23-102"><a href="#cb23-102"></a>        baseline_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">-baseline"</span></span>
<span id="cb23-103"><a href="#cb23-103"></a>        baseline_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-104"><a href="#cb23-104"></a></span>
<span id="cb23-105"><a href="#cb23-105"></a>        df <span class="op">=</span> data.copy().dropna()</span>
<span id="cb23-106"><a href="#cb23-106"></a></span>
<span id="cb23-107"><a href="#cb23-107"></a>        <span class="co"># We want to save the header only for the train baseline</span></span>
<span id="cb23-108"><a href="#cb23-108"></a>        <span class="co"># but not for the test baseline. We'll use the test baseline</span></span>
<span id="cb23-109"><a href="#cb23-109"></a>        <span class="co"># to generate predictions later, and we can't have a header line</span></span>
<span id="cb23-110"><a href="#cb23-110"></a>        <span class="co"># because the model won't be able to make a prediction for it.</span></span>
<span id="cb23-111"><a href="#cb23-111"></a>        header <span class="op">=</span> split <span class="op">==</span> <span class="st">"train"</span></span>
<span id="cb23-112"><a href="#cb23-112"></a>        df.to_csv(baseline_path <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">-baseline.csv"</span>, header<span class="op">=</span>header, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-113"><a href="#cb23-113"></a></span>
<span id="cb23-114"><a href="#cb23-114"></a></span>
<span id="cb23-115"><a href="#cb23-115"></a><span class="kw">def</span> _save_splits(base_directory, X_train, y_train, X_validation, y_validation, X_test, y_test):</span>
<span id="cb23-116"><a href="#cb23-116"></a>    <span class="co">"""</span></span>
<span id="cb23-117"><a href="#cb23-117"></a><span class="co">    This function concatenates the transformed features and the target variable, and</span></span>
<span id="cb23-118"><a href="#cb23-118"></a><span class="co">    saves each one of the split sets to disk.</span></span>
<span id="cb23-119"><a href="#cb23-119"></a><span class="co">    """</span></span>
<span id="cb23-120"><a href="#cb23-120"></a></span>
<span id="cb23-121"><a href="#cb23-121"></a>    train <span class="op">=</span> np.concatenate((X_train, y_train), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-122"><a href="#cb23-122"></a>    validation <span class="op">=</span> np.concatenate((X_validation, y_validation), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-123"><a href="#cb23-123"></a>    test <span class="op">=</span> np.concatenate((X_test, y_test), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-124"><a href="#cb23-124"></a></span>
<span id="cb23-125"><a href="#cb23-125"></a>    train_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb23-126"><a href="#cb23-126"></a>    validation_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"validation"</span></span>
<span id="cb23-127"><a href="#cb23-127"></a>    test_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb23-128"><a href="#cb23-128"></a></span>
<span id="cb23-129"><a href="#cb23-129"></a>    train_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-130"><a href="#cb23-130"></a>    validation_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-131"><a href="#cb23-131"></a>    test_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-132"><a href="#cb23-132"></a></span>
<span id="cb23-133"><a href="#cb23-133"></a>    pd.DataFrame(train).to_csv(train_path <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-134"><a href="#cb23-134"></a>    pd.DataFrame(validation).to_csv(validation_path <span class="op">/</span> <span class="st">"validation.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-135"><a href="#cb23-135"></a>    pd.DataFrame(test).to_csv(test_path <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-136"><a href="#cb23-136"></a></span>
<span id="cb23-137"><a href="#cb23-137"></a></span>
<span id="cb23-138"><a href="#cb23-138"></a><span class="kw">def</span> _save_model(base_directory, target_transformer, features_transformer):</span>
<span id="cb23-139"><a href="#cb23-139"></a>    <span class="co">"""</span></span>
<span id="cb23-140"><a href="#cb23-140"></a><span class="co">    This function creates a model.tar.gz file that contains the two transformation</span></span>
<span id="cb23-141"><a href="#cb23-141"></a><span class="co">    pipelines we built to transform the data.</span></span>
<span id="cb23-142"><a href="#cb23-142"></a><span class="co">    """</span></span>
<span id="cb23-143"><a href="#cb23-143"></a></span>
<span id="cb23-144"><a href="#cb23-144"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> directory:</span>
<span id="cb23-145"><a href="#cb23-145"></a>        joblib.dump(target_transformer, os.path.join(directory, <span class="st">"target.joblib"</span>))</span>
<span id="cb23-146"><a href="#cb23-146"></a>        joblib.dump(features_transformer, os.path.join(directory, <span class="st">"features.joblib"</span>))</span>
<span id="cb23-147"><a href="#cb23-147"></a>    </span>
<span id="cb23-148"><a href="#cb23-148"></a>        model_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb23-149"><a href="#cb23-149"></a>        model_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-150"><a href="#cb23-150"></a>    </span>
<span id="cb23-151"><a href="#cb23-151"></a>        <span class="cf">with</span> tarfile.<span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">str</span>(model_path <span class="op">/</span> <span class="st">'model.tar.gz'</span>)<span class="sc">}</span><span class="ss">"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb23-152"><a href="#cb23-152"></a>            tar.add(os.path.join(directory, <span class="st">"target.joblib"</span>), arcname<span class="op">=</span><span class="st">"target.joblib"</span>)</span>
<span id="cb23-153"><a href="#cb23-153"></a>            tar.add(os.path.join(directory, <span class="st">"features.joblib"</span>), arcname<span class="op">=</span><span class="st">"features.joblib"</span>)</span>
<span id="cb23-154"><a href="#cb23-154"></a></span>
<span id="cb23-155"><a href="#cb23-155"></a>    </span>
<span id="cb23-156"><a href="#cb23-156"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb23-157"><a href="#cb23-157"></a>    preprocess(base_directory<span class="op">=</span><span class="st">"/opt/ml/processing"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div class="cell" data-tags="[]" data-execution_count="207">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_data_splits(directory):</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"train"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"validation"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"test"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_baselines(directory):</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"train-baseline"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"test-baseline"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_creates_two_models(directory):</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    model_path <span class="op">=</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    tar <span class="op">=</span> tarfile.<span class="bu">open</span>(model_path <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"r:gz"</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"features.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"target.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_splits_are_transformed(directory):</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train"</span> <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    validation <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"validation"</span> <span class="op">/</span> <span class="st">"validation.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    test <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test"</span> <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After transforming the data, the number of features should be 7:</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 3 - island (one-hot encoded)</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_length_mm = 1</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_depth_mm</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - flipper_length_mm</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - body_mass_g</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    number_of_features <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The transformed splits should have an additional column for the target</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variable.</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> train.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> validation.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> test.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_baseline_is_not_transformed(directory):</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train-baseline"</span> <span class="op">/</span> <span class="st">"train-baseline.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>    island <span class="op">=</span> baseline.iloc[:, <span class="dv">1</span>].unique()</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Biscoe"</span> <span class="kw">in</span> island</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Torgersen"</span> <span class="kw">in</span> island</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Dream"</span> <span class="kw">in</span> island</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_test_baseline_is_not_transformed(directory):</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test-baseline"</span> <span class="op">/</span> <span class="st">"test-baseline.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>    island <span class="op">=</span> baseline.iloc[:, <span class="dv">1</span>].unique()</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Biscoe"</span> <span class="kw">in</span> island</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Torgersen"</span> <span class="kw">in</span> island</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Dream"</span> <span class="kw">in</span> island</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_baseline_includes_header(directory):</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train-baseline"</span> <span class="op">/</span> <span class="st">"train-baseline.csv"</span>)</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> baseline.columns[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"species"</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_test_baseline_does_not_include_header(directory):</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test-baseline"</span> <span class="op">/</span> <span class="st">"test-baseline.csv"</span>)</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> baseline.columns[<span class="dv">0</span>] <span class="op">!=</span> <span class="st">"species"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-3---setting-up-the-processing-step" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-the-processing-step">Step 3 - Setting up the Processing Step</h3>
<p>Let’s now define the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> that we’ll use in the pipeline to run the script that will split and transform the data.</p>
<p>Several SageMaker Pipeline steps support caching. When a step runs, and dependending on the configured caching policy, SageMaker will try to reuse the result of a previous successful run of the same step. You can find more information about this topic in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-caching.html">Caching Pipeline Steps</a>. Let’s define a caching policy that we’ll reuse on every step:</p>
<div class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> CacheConfig</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>cache_config <span class="op">=</span> CacheConfig(enable_caching<span class="op">=</span><span class="va">True</span>, expire_after<span class="op">=</span><span class="st">"15d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can parameterize a SageMaker Pipeline to make it more flexible. In this case, we’ll use a parameter to pass the location of the dataset we want to process. We can execute the pipeline with different datasets by changing the value of this parameter. To read more about these parameters, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameters</a>.</p>
<div class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterString</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>dataset_location <span class="op">=</span> ParameterString(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"dataset_location"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/data"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A processor gives the Processing Step information about the hardware and software that SageMaker should use to launch the Processing Job. To run the script we created, we need access to Scikit-Learn, so we can use the <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor">SKLearnProcessor</a> processor that comes out-of-the-box with the SageMaker’s Python SDK.</p>
<p>SageMaker manages the infrastructure of a Processing Job. It provisions resources for the duration of the job, and cleans up when it completes. The Processing Container image that SageMaker uses to run a Processing Job can either be a SageMaker built-in image or a custom image.</p>
<p>The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks.html">Data Processing with Framework Processors</a> page discusses other built-in processors you can use. The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">Docker Registry Paths and Example Code</a> page contains information about the available framework versions for each region.</p>
<div class="cell" data-code="true" data-execution_count="210">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.processing <span class="im">import</span> SKLearnProcessor</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> SKLearnProcessor(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"preprocess-data"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># By default, a new account doesn't have access to `ml.m5.xlarge` instances.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you haven't requested a quota increase yet, you can use an</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `ml.t3.medium` instance type instead. This will work out of the box, but</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the Processing Job will take significantly longer than it should have.</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To get access to `ml.m5.xlarge` instances, you can request a quota</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># increase under the Service Quotas section in your AWS account.</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now define the Processing Step that we’ll use in the pipeline. This step requires a list of inputs that we need on the preprocessing script. In this case, the input is the dataset we stored in S3. We also have a few outputs that we want SageMaker to capture when the Processing Job finishes.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="211">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> ProcessingStep</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.processing <span class="im">import</span> ProcessingInput, ProcessingOutput</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>preprocessing_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"preprocess-data"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>processor.run(</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/preprocessor.py"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>dataset_location, destination<span class="op">=</span><span class="st">"/opt/ml/processing/input"</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"train"</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/train"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/train"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"validation"</span>,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/validation"</span>,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/validation"</span>,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/test"</span>,</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/model"</span>,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"train-baseline"</span>,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/train-baseline"</span>,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/train-baseline"</span>,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"test-baseline"</span>,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/test-baseline"</span>,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/test-baseline"</span>,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-4---creating-the-pipeline">Step 4 - Creating the Pipeline</h3>
<p>We can now create the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="212">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_definition_config <span class="im">import</span> PipelineDefinitionConfig</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>pipeline_definition_config <span class="op">=</span> PipelineDefinitionConfig(use_custom_job_prefix<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>session1_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session1-pipeline"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>session1_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start the pipeline:</p>
<div class="cell" data-code="true" data-execution_count="213">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>session1_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignments" class="level3">
<h3 class="anchored" data-anchor-id="assignments">Assignments</h3>
<ul>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 1.1</strong></span> For this assignment, you should run the pipeline on your environment using Local Mode and then switch it to run in SageMaker. After completing this assignment, you should have your environment fully configured and your pipeline running without any issues. This assignment is fundamental to the rest of the program, so make sure you complete it before moving on to any other assignments.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 1.2</strong></span> The pipeline uses Random Sampling to split the dataset. Modify the code to use Stratified Sampling instead. The goal of this assignment is to help you familiarize with how to modify the preprocessing script and re-run the pipeline to see your changes in action.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 1.3</strong></span> We can specify different parameter values in a pipeline at the time we start it. In this session, we defined a <code>dataset_location</code> parameter that specifies the location of the data that we want the pipeline to process. For this assignment, use ChatGPT to generate dataset with 500 random penguins and store the file in S3. Then, run the pipeline pointing the <code>dataset_location</code> to the new dataset. Here is an explanation of how to <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/run-pipeline.html#run-pipeline-parametrized">override default parameters during a pipeline execution</a>. You can use the Advanced Data Analysis tool from ChatGPT to generate the fake data. If you don’t have access to it, you can simply duplicate your dataset and store it at a different S3 location.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 1.4</strong></span> For this assignment, we want to run a distributed Processing Job across multiple instances to capitalize the <code>island</code> column of the dataset. Your dataset will consist of 10 different files stored in S3. Set up a Processing Step using two instances. When specifying the input to the Processing Step, you must set the <code>ProcessingInput.s3_data_distribution_type</code> attribute to <code>ShardedByS3Key</code>. By doing this, SageMaker will run a cluster with two instances simultaneously, each with access to half the files. Check the <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_S3DataSource.html"><code>S3DataDistributionType</code></a> documentation for more information.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 1.5</strong></span> You can use <a href="https://aws.amazon.com/sagemaker/data-wrangler/">Amazon SageMaker Data Wrangler</a> to complete each step of the data preparation workflow (including data selection, cleansing, exploration, visualization, and processing at scale) from a single visual interface. For this assignment, load the Data Wrangler interface and use it to build the same transformations we implemented using the Scikit-Learn Pipeline. If you have questions, open the <a href="penguins.flow">Penguins Data Flow</a> included in this repository.</p></li>
</ul>
</section>
</section>
<section id="session-2---building-models-and-the-training-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="session-2---building-models-and-the-training-pipeline">Session 2 - Building Models And The Training Pipeline</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> we built in the previous session with a step to train a model. We’ll explore the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a> and the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-tuning">Tuning Step</a>.</p>
<p><a href="images/training.png" target="_blank"> <img src="images/training.png" alt="Training" style="max-width: 750px;"></a></p>
<p>We’ll introduce <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">Amazon SageMaker Experiments</a> and use them during training. For more information about this topic, check the <a href="https://sagemaker.readthedocs.io/en/v2.174.0/experiments/sagemaker.experiments.html">SageMaker Experiments’ SDK documentation</a>.</p>
<section id="step-1---creating-the-training-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-training-script">Step 1 - Creating the Training Script</h3>
<p>Here’s a high-level overview of the training step and the Training Job that SageMaker creates behind the scenes:</p>
<p><a href="images/train-model.png" target="_blank"> <img src="images/train-model.png" alt="High-level overview of the Train Model Step and SageMaker's Training Jobs" style="max-width: 750px;"></a></p>
<p>This following script is responsible for training a neural network using the train data, validating the model, and saving it so we can later use it:</p>
<div id="training-script" class="cell" data-tags="[]" data-execution_count="214">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>train.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="im">import</span> os</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="im">import</span> argparse</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb31-9"><a href="#cb31-9"></a></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense</span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> SGD</span>
<span id="cb31-13"><a href="#cb31-13"></a></span>
<span id="cb31-14"><a href="#cb31-14"></a></span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="kw">def</span> train(model_directory, train_path, validation_path, epochs<span class="op">=</span><span class="dv">50</span>, batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb31-16"><a href="#cb31-16"></a>    X_train <span class="op">=</span> pd.read_csv(Path(train_path) <span class="op">/</span> <span class="st">"train.csv"</span>)</span>
<span id="cb31-17"><a href="#cb31-17"></a>    y_train <span class="op">=</span> X_train[X_train.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb31-18"><a href="#cb31-18"></a>    X_train.drop(X_train.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-19"><a href="#cb31-19"></a>    </span>
<span id="cb31-20"><a href="#cb31-20"></a>    X_validation <span class="op">=</span> pd.read_csv(Path(validation_path) <span class="op">/</span> <span class="st">"validation.csv"</span>)</span>
<span id="cb31-21"><a href="#cb31-21"></a>    y_validation <span class="op">=</span> X_validation[X_validation.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb31-22"><a href="#cb31-22"></a>    X_validation.drop(X_validation.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-23"><a href="#cb31-23"></a>        </span>
<span id="cb31-24"><a href="#cb31-24"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb31-25"><a href="#cb31-25"></a>        Dense(<span class="dv">10</span>, input_shape<span class="op">=</span>(X_train.shape[<span class="dv">1</span>],), activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb31-26"><a href="#cb31-26"></a>        Dense(<span class="dv">8</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb31-27"><a href="#cb31-27"></a>        Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">"softmax"</span>),</span>
<span id="cb31-28"><a href="#cb31-28"></a>    ])</span>
<span id="cb31-29"><a href="#cb31-29"></a>    </span>
<span id="cb31-30"><a href="#cb31-30"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb31-31"><a href="#cb31-31"></a>        optimizer<span class="op">=</span>SGD(learning_rate<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb31-32"><a href="#cb31-32"></a>        loss<span class="op">=</span><span class="st">"sparse_categorical_crossentropy"</span>,</span>
<span id="cb31-33"><a href="#cb31-33"></a>        metrics<span class="op">=</span>[<span class="st">"accuracy"</span>]</span>
<span id="cb31-34"><a href="#cb31-34"></a>    )</span>
<span id="cb31-35"><a href="#cb31-35"></a></span>
<span id="cb31-36"><a href="#cb31-36"></a>    model.fit(</span>
<span id="cb31-37"><a href="#cb31-37"></a>        X_train, </span>
<span id="cb31-38"><a href="#cb31-38"></a>        y_train, </span>
<span id="cb31-39"><a href="#cb31-39"></a>        validation_data<span class="op">=</span>(X_validation, y_validation),</span>
<span id="cb31-40"><a href="#cb31-40"></a>        epochs<span class="op">=</span>epochs, </span>
<span id="cb31-41"><a href="#cb31-41"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb31-42"><a href="#cb31-42"></a>        verbose<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb31-43"><a href="#cb31-43"></a>    )</span>
<span id="cb31-44"><a href="#cb31-44"></a></span>
<span id="cb31-45"><a href="#cb31-45"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_validation), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb31-46"><a href="#cb31-46"></a>    <span class="bu">print</span>(<span class="ss">f"Validation accuracy: </span><span class="sc">{</span>accuracy_score(y_validation, predictions)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-47"><a href="#cb31-47"></a>    </span>
<span id="cb31-48"><a href="#cb31-48"></a>    model_filepath <span class="op">=</span> Path(model_directory) <span class="op">/</span> <span class="st">"001"</span></span>
<span id="cb31-49"><a href="#cb31-49"></a>    model.save(model_filepath)    </span>
<span id="cb31-50"><a href="#cb31-50"></a>    </span>
<span id="cb31-51"><a href="#cb31-51"></a></span>
<span id="cb31-52"><a href="#cb31-52"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb31-53"><a href="#cb31-53"></a>    <span class="co"># Any hyperparameters provided by the training job are passed to </span></span>
<span id="cb31-54"><a href="#cb31-54"></a>    <span class="co"># the entry point as script arguments. </span></span>
<span id="cb31-55"><a href="#cb31-55"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb31-56"><a href="#cb31-56"></a>    parser.add_argument(<span class="st">"--epochs"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb31-57"><a href="#cb31-57"></a>    parser.add_argument(<span class="st">"--batch_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb31-58"><a href="#cb31-58"></a>    args, _ <span class="op">=</span> parser.parse_known_args()</span>
<span id="cb31-59"><a href="#cb31-59"></a></span>
<span id="cb31-60"><a href="#cb31-60"></a>    train(</span>
<span id="cb31-61"><a href="#cb31-61"></a>        <span class="co"># This is the location where we need to save our model. SageMaker will</span></span>
<span id="cb31-62"><a href="#cb31-62"></a>        <span class="co"># create a model.tar.gz file with anything inside this directory when</span></span>
<span id="cb31-63"><a href="#cb31-63"></a>        <span class="co"># the training script finishes.</span></span>
<span id="cb31-64"><a href="#cb31-64"></a>        model_directory<span class="op">=</span>os.environ[<span class="st">"SM_MODEL_DIR"</span>],</span>
<span id="cb31-65"><a href="#cb31-65"></a></span>
<span id="cb31-66"><a href="#cb31-66"></a>        <span class="co"># SageMaker creates one channel for each one of the inputs to the</span></span>
<span id="cb31-67"><a href="#cb31-67"></a>        <span class="co"># Training Step.</span></span>
<span id="cb31-68"><a href="#cb31-68"></a>        train_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_TRAIN"</span>],</span>
<span id="cb31-69"><a href="#cb31-69"></a>        validation_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_VALIDATION"</span>],</span>
<span id="cb31-70"><a href="#cb31-70"></a></span>
<span id="cb31-71"><a href="#cb31-71"></a>        epochs<span class="op">=</span>args.epochs,</span>
<span id="cb31-72"><a href="#cb31-72"></a>        batch_size<span class="op">=</span>args.batch_size,</span>
<span id="cb31-73"><a href="#cb31-73"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div class="cell" data-tags="[]" data-execution_count="215">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> train <span class="im">import</span> train</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>, </span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_saves_a_folder_with_model_assets(directory):</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"001"</span> <span class="kw">in</span> output</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"saved_model.pb"</span> <span class="kw">in</span> assets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---setting-up-the-training-step" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-the-training-step">Step 2 - Setting up the Training Step</h3>
<p>We can now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a> that we can add to the pipeline. This Training Step will create a SageMaker Training Job in the background, run the training script, and upload the output to S3. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TrainingStep">TrainingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>SageMaker uses the concept of an <a href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html">Estimator</a> to handle end-to-end training and deployment tasks. For this example, we will use the built-in <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-estimator">TensorFlow Estimator</a> to run the training script we wrote before.</p>
<p>SageMaker manages the infrastructure of a Training Job. It provisions resources for the duration of the job, and cleans up when it completes. The Training Container image that SageMaker uses to run a Training Job can either be a SageMaker built-in image or a custom image.</p>
<p>The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">Docker Registry Paths and Example Code</a> page contains information about the available framework versions for each region. Here, you can also check the available SageMaker <a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Deep Learning Container images</a>.</p>
<p>Notice the list of hyperparameters defined below. SageMaker will pass these hyperparameters as arguments to the entry point of the training script.</p>
<p>We are going to use <a href="https://sagemaker.readthedocs.io/en/v2.174.0/experiments/sagemaker.experiments.html">SageMaker Experiments</a> to log information from the Training Job. For more information, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">Manage Machine Learning with Amazon SageMaker Experiments</a>. The list of metric definitions will tell SageMaker which metrics to track and how to parse them from the Training Job logs.</p>
<div class="cell" data-tags="[]" data-execution_count="216">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlow</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>estimator <span class="op">=</span> TensorFlow(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"training"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/train.py"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will pass these hyperparameters as arguments</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to the entry point of the training script.</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    hyperparameters<span class="op">=</span>{</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: <span class="dv">50</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_size"</span>: <span class="dv">32</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will track these metrics as part of the experiment</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># associated to this pipeline. The metric definitions tells</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker how to parse the values from the Training Job logs.</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>[</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"loss"</span>, <span class="st">"Regex"</span>: <span class="st">"loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_loss"</span>, <span class="st">"Regex"</span>: <span class="st">"val_loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    disable_profiler<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a>. This Training Step will create a SageMaker Training Job in the background, run the training script, and upload the output to S3. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TrainingStep">TrainingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>This step will receive the train and validation split from the previous step as inputs.</p>
<p>Here, we are using two input channels, <code>train</code> and <code>validation</code>. SageMaker will automatically create an environment variable corresponding to each of these channels following the format <code>SM_CHANNEL_[channel_name]</code>:</p>
<ul>
<li><code>SM_CHANNEL_TRAIN</code>: This environment variable will contain the path to the data in the <code>train</code> channel</li>
<li><code>SM_CHANNEL_VALIDATION</code>: This environment variable will contain the path to the data in the <code>validation</code> channel</li>
</ul>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="217">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TrainingStep</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.inputs <span class="im">import</span> TrainingInput</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>train_model_step <span class="op">=</span> TrainingStep(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"train-model"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>estimator.fit(</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"train"</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"validation"</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---setting-up-a-tuning-step" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-a-tuning-step">Step 3 - Setting up a Tuning Step</h3>
<p>Let’s now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-tuning">Tuning Step</a>. This Tuning Step will create a SageMaker Hyperparameter Tuning Job in the background and use the training script to train different model variants and choose the best one. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep">TuningStep</a> SageMaker’s SDK documentation for more information.</p>
<p>Since we could use the Training of the Tuning Step to create the model, we’ll define this constant to indicate which approach we want to run. Notice that the Tuning Step is not supported in Local Mode.</p>
<div class="cell" data-execution_count="218">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>USE_TUNING_STEP <span class="op">=</span> <span class="va">False</span> <span class="kw">and</span> <span class="kw">not</span> LOCAL_MODE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Tuning Step requires a <a href="https://sagemaker.readthedocs.io/en/stable/api/training/tuner.html">HyperparameterTuner</a> reference to configure the Hyperparameter Tuning Job.</p>
<p>Here is the configuration that we’ll use to find the best model:</p>
<ol type="1">
<li><code>objective_metric_name</code>: This is the name of the metric the tuner will use to determine the best model.</li>
<li><code>objective_type</code>: This is the objective of the tuner. It specifies whether it should minimize the metric or maximize it. In this example, since we are using the validation accuracy of the model, we want the objective to be “Maximize.” If we were using the loss of the model, we would set the objective to “Minimize.”</li>
<li><code>metric_definitions</code>: Defines how the tuner will determine the metric’s value by looking at the output logs of the training process.</li>
</ol>
<p>The tuner expects the list of the hyperparameters you want to explore. You can use subclasses of the <a href="https://sagemaker.readthedocs.io/en/stable/api/training/parameter.html#sagemaker.parameter.ParameterRange">Parameter</a> class to specify different types of hyperparameters. This example explores different values for the <code>epochs</code> hyperparameter.</p>
<p>Finally, you can control the number of jobs and how many of them will run in parallel using the following two arguments:</p>
<ul>
<li><code>max_jobs</code>: Defines the maximum total number of training jobs to start for the hyperparameter tuning job.</li>
<li><code>max_parallel_jobs</code>: Defines the maximum number of parallel training jobs to start.</li>
</ul>
<div class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tuner <span class="im">import</span> HyperparameterTuner</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.parameter <span class="im">import</span> IntegerParameter</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> HyperparameterTuner(</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    estimator,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    objective_metric_name<span class="op">=</span><span class="st">"val_accuracy"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    objective_type<span class="op">=</span><span class="st">"Maximize"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    hyperparameter_ranges<span class="op">=</span>{</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: IntegerParameter(<span class="dv">10</span>, <span class="dv">50</span>),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>[{<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>}],</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    max_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    max_parallel_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the Tuning Step using the tuner we configured before.</p>
<p>Here’s a high-level overview of this step and the Hyperparameter Tuning Job that SageMaker creates behind the scenes:</p>
<p><a href="images/tune-model.png" target="_blank"> <img src="images/tune-model.png" alt="High-level overview of the Tune Model Step and SageMaker's Hyperparameter Tuning Jobs" style="max-width: 750px;"></a></p>
<div class="cell" data-tags="[]" data-execution_count="220">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TuningStep</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>tune_model_step <span class="op">=</span> TuningStep(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"tune-model"</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>tuner.fit(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"train"</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"validation"</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-4---creating-the-pipeline-1">Step 4 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="221">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>session2_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session2-pipeline"</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>session2_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start the pipeline:</p>
<div class="cell" data-code="true" data-execution_count="222">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>session2_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignments-1" class="level3">
<h3 class="anchored" data-anchor-id="assignments-1">Assignments</h3>
<ul>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 2.1</strong></span> The training script trains the model using a hard-coded learning rate value. Modify the script to accept the learning rate as a parameter we can pass from the pipeline.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 2.2</strong></span> We currently define the number of epochs to train the model as a constant that we pass to the Estimator using the list of hyperparameters. Replace this constant with a new Pipeline Parameter named <code>training_epochs</code>.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 2.3</strong></span> The current tuning process aims to find the model with the highest validation accuracy. Modify the code so the best model is the one with the lowest training loss.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 2.4</strong></span> We used an instance of <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor"><code>SKLearnProcessor</code></a> to run the script that transforms and splits the data. While this processor is convenient, it doesn’t allow us to install additional libraries in the container. Modify the code to use an instance of <a href="https://sagemaker.readthedocs.io/en/stable/api/training/processing.html#sagemaker.processing.FrameworkProcessor"><code>FrameworkProcessor</code></a> instead <code>SKLearnProcessor</code>. This class will allow us to specify a directory containing a <code>requirements.txt</code> file listing any additional dependencies. SageMaker will install these libraries in the processing container before triggering the processing job.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 2.5</strong></span> We configured the Training Step to log information from the Training Job as part of the SageMaker Experiment associated to the pipeline. As part of this assignment, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">Manage Machine Learning with Amazon SageMaker Experiments</a> and explore the generated experiments in the SageMaker Studio Console so you can familiarize with the information SageMaker logs during training.</p></li>
</ul>
</section>
</section>
<section id="session-3---evaluating-and-versioning-models" class="level2">
<h2 class="anchored" data-anchor-id="session-3---evaluating-and-versioning-models">Session 3 - Evaluating and Versioning Models</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a step to evaluate the model and register it if it reaches a predefined accuracy threshold.</p>
<p><a href="images/training.png" target="_blank"> <img src="images/training.png" alt="Training" style="max-width: 750px;"></a></p>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to execute an evaluation script. We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> to determine whether the model’s accuracy is above a threshold, and a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model">Model Step</a> to register the model in the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry.html">SageMaker Model Registry</a>.</p>
<section id="step-1---creating-the-evaluation-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-evaluation-script">Step 1 - Creating the Evaluation Script</h3>
<p>Here’s a high-level overview of the evaluation step and the Processing Job that SageMaker creates behind the scenes:</p>
<p><a href="images/evaluate-model.png" target="_blank"> <img src="images/evaluate-model.png" alt="High-level overview of the Evaluate Model Step and SageMaker's Processing Jobs" style="max-width: 750px;"></a></p>
<p>Let’s create the evaluation script. The Processing Step will spin up a Processing Job and run this script inside a container. This script is responsible for loading the model we created and evaluating it on the test set. Before finishing, this script will generate an evaluation report of the model.</p>
<div id="evaluation-script" class="cell" data-tags="[]" data-execution_count="223">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>evaluation.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a><span class="im">import</span> json</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="im">import</span> tarfile</span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb40-9"><a href="#cb40-9"></a></span>
<span id="cb40-10"><a href="#cb40-10"></a></span>
<span id="cb40-11"><a href="#cb40-11"></a><span class="kw">def</span> evaluate(model_path, test_path, output_path):</span>
<span id="cb40-12"><a href="#cb40-12"></a>    X_test <span class="op">=</span> pd.read_csv(Path(test_path) <span class="op">/</span> <span class="st">"test.csv"</span>)</span>
<span id="cb40-13"><a href="#cb40-13"></a>    y_test <span class="op">=</span> X_test[X_test.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb40-14"><a href="#cb40-14"></a>    X_test.drop(X_test.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-15"><a href="#cb40-15"></a></span>
<span id="cb40-16"><a href="#cb40-16"></a>    <span class="co"># Let's now extract the model package so we can load </span></span>
<span id="cb40-17"><a href="#cb40-17"></a>    <span class="co"># it in memory.</span></span>
<span id="cb40-18"><a href="#cb40-18"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(Path(model_path) <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb40-19"><a href="#cb40-19"></a>        tar.extractall(path<span class="op">=</span>Path(model_path))</span>
<span id="cb40-20"><a href="#cb40-20"></a>        </span>
<span id="cb40-21"><a href="#cb40-21"></a>    model <span class="op">=</span> keras.models.load_model(Path(model_path) <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb40-22"><a href="#cb40-22"></a>    </span>
<span id="cb40-23"><a href="#cb40-23"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_test), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb40-24"><a href="#cb40-24"></a>    accuracy <span class="op">=</span> accuracy_score(y_test, predictions)</span>
<span id="cb40-25"><a href="#cb40-25"></a>    <span class="bu">print</span>(<span class="ss">f"Test accuracy: </span><span class="sc">{</span>accuracy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-26"><a href="#cb40-26"></a></span>
<span id="cb40-27"><a href="#cb40-27"></a>    <span class="co"># Let's create an evaluation report using the model accuracy.</span></span>
<span id="cb40-28"><a href="#cb40-28"></a>    evaluation_report <span class="op">=</span> {</span>
<span id="cb40-29"><a href="#cb40-29"></a>        <span class="st">"metrics"</span>: {</span>
<span id="cb40-30"><a href="#cb40-30"></a>            <span class="st">"accuracy"</span>: {</span>
<span id="cb40-31"><a href="#cb40-31"></a>                <span class="st">"value"</span>: accuracy</span>
<span id="cb40-32"><a href="#cb40-32"></a>            },</span>
<span id="cb40-33"><a href="#cb40-33"></a>        },</span>
<span id="cb40-34"><a href="#cb40-34"></a>    }</span>
<span id="cb40-35"><a href="#cb40-35"></a>    </span>
<span id="cb40-36"><a href="#cb40-36"></a>    Path(output_path).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-37"><a href="#cb40-37"></a>    <span class="cf">with</span> <span class="bu">open</span>(Path(output_path) <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb40-38"><a href="#cb40-38"></a>        f.write(json.dumps(evaluation_report))</span>
<span id="cb40-39"><a href="#cb40-39"></a>        </span>
<span id="cb40-40"><a href="#cb40-40"></a>        </span>
<span id="cb40-41"><a href="#cb40-41"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb40-42"><a href="#cb40-42"></a>    evaluate(</span>
<span id="cb40-43"><a href="#cb40-43"></a>        model_path<span class="op">=</span><span class="st">"/opt/ml/processing/model/"</span>, </span>
<span id="cb40-44"><a href="#cb40-44"></a>        test_path<span class="op">=</span><span class="st">"/opt/ml/processing/test/"</span>,</span>
<span id="cb40-45"><a href="#cb40-45"></a>        output_path<span class="op">=</span><span class="st">"/opt/ml/processing/evaluation/"</span></span>
<span id="cb40-46"><a href="#cb40-46"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div class="cell" data-tags="[]" data-execution_count="224">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessor <span class="im">import</span> preprocess</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> train <span class="im">import</span> train</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> evaluation <span class="im">import</span> evaluate</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>, </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After training a model, we need to prepare a package just like</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker would. This package is what the evaluation script is</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expecting as an input.</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        tar.add(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>, arcname<span class="op">=</span><span class="st">"001"</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    evaluate(</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>directory, </span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        test_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"test"</span>,</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"evaluation"</span>,</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"evaluation"</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluate_generates_evaluation_report(directory):</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> os.listdir(directory)</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"evaluation.json"</span> <span class="kw">in</span> output</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluation_report_contains_accuracy(directory):</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"metrics"</span> <span class="kw">in</span> report</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"accuracy"</span> <span class="kw">in</span> report[<span class="st">"metrics"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---setting-up-the-evaluation-step" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-the-evaluation-step">Step 2 - Setting up the Evaluation Step</h3>
<p>To run the evaluation script, we will use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> configured with <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks-tensorflow.html">TensorFlowProcessor</a> because the script needs access to TensorFlow.</p>
<div class="cell" data-code="true" data-execution_count="225">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlowProcessor</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>evaluation_processor <span class="op">=</span> TensorFlowProcessor(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"evaluation-processor"</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One of the inputs to the Evaluation Step will be the model assets. We can use the <code>USE_TUNING_STEP</code> flag to determine whether we created the model using a Training Step or a Tuning Step. In case we are using the Tuning Step, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep.get_top_model_s3_uri">TuningStep.get_top_model_s3_uri()</a> function to get the model assets from the top performing training job of the Hyperparameter Tuning Job.</p>
<div class="cell" data-execution_count="226">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>model_assets <span class="op">=</span> train_model_step.properties.ModelArtifacts.S3ModelArtifacts</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> USE_TUNING_STEP:</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    model_assets <span class="op">=</span> tune_model_step.get_top_model_s3_uri(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        top_k<span class="op">=</span><span class="dv">0</span>, s3_bucket<span class="op">=</span>config[<span class="st">"session"</span>].default_bucket()</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>SageMaker supports mapping outputs to property files. This is useful when accessing a specific property from the pipeline. In our case, we want to access the accuracy of the model in the Condition Step, so we’ll map the evaluation report to a property file. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-propertyfile.html">How to Build and Manage Property Files</a> for more information.</p>
<div class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.properties <span class="im">import</span> PropertyFile</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>evaluation_report <span class="op">=</span> PropertyFile(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluation-report"</span>, output_name<span class="op">=</span><span class="st">"evaluation"</span>, path<span class="op">=</span><span class="st">"evaluation.json"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are now ready to define the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> that will run the evaluation script:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="228">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>evaluate_model_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluate-model"</span>,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>evaluation_processor.run(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The first input is the test split that we generated on</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the first step of the pipeline when we split and</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># transformed the data.</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"test"</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The second input is the model that we generated on</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the Training or Tunning Step.</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>model_assets,</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>,</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The output is the evaluation report that we generated</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># in the evaluation script.</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"evaluation"</span>, source<span class="op">=</span><span class="st">"/opt/ml/processing/evaluation"</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>CODE_FOLDER<span class="sc">}</span><span class="ss">/evaluation.py"</span>,</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    property_files<span class="op">=</span>[evaluation_report],</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---registering-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-3---registering-the-model">Step 3 - Registering the Model</h3>
<p>Let’s now create a new version of the model and register it in the Model Registry. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry-version.html">Register a Model Version</a> for more information about model registration.</p>
<p>Here’s a high-level overview of how to register a model in the Model Registry:</p>
<p><a href="images/registration-step.png" target="_blank"> <img src="images/registration-step.png" alt="High-level overview of the registering a model using the SageMaker's Model Step" style="max-width: 750px;"></a></p>
<p>First, let’s define the name of the group where we’ll register the model:</p>
<div class="cell" data-execution_count="229">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the model that we’ll register in the Model Registry. The model we trained uses TensorFlow, so we can use the built-in <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-serving-model">TensorFlowModel</a> class to create an instance of the model:</p>
<div class="cell" data-execution_count="230">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow.model <span class="im">import</span> TensorFlowModel</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>tensorflow_model <span class="op">=</span> TensorFlowModel(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>model_assets,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we register a model in the Model Registry, we can attach relevant metadata to it. We’ll use the evaluation report we generated during the Evaluation Step to populate the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">metrics</a> of this model:</p>
<div class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_metrics <span class="im">import</span> ModelMetrics, MetricsSource</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> Join</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>Join(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">"/"</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span>[</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                evaluate_model_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"evaluation"</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"evaluation.json"</span>,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model">Model Step</a> to register the model. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.model_step.ModelStep">ModelStep</a> SageMaker’s SDK documentation for more information.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="232">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.model_step <span class="im">import</span> ModelStep</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"register-model"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>tensorflow_model.register(</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        model_package_group_name<span class="op">=</span>MODEL_PACKAGE_GROUP,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>        approval_status<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        content_types<span class="op">=</span>[<span class="st">"text/csv"</span>],</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        response_types<span class="op">=</span>[<span class="st">"application/json"</span>],</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        inference_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        transform_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        domain<span class="op">=</span><span class="st">"MACHINE_LEARNING"</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"CLASSIFICATION"</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        framework<span class="op">=</span><span class="st">"TENSORFLOW"</span>,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-a-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-a-condition-step">Step 4 - Setting up a Condition Step</h3>
<p>We only want to register a new model if its accuracy exceeds a predefined threshold. We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> together with the evaluation report we generated to accomplish this.</p>
<p>Here’s a high-level overview of the Condition Step:</p>
<p><a href="images/condition-step.png" target="_blank"> <img src="images/condition-step.png" alt="High-level overview of the Condition Step" style="max-width: 750px;"></a></p>
<p>Let’s define a new <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameter</a> to specify the minimum accuracy that the model should reach for it to be registered.</p>
<div class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterFloat</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>accuracy_threshold <span class="op">=</span> ParameterFloat(name<span class="op">=</span><span class="st">"accuracy_threshold"</span>, default_value<span class="op">=</span><span class="fl">0.70</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the model’s accuracy is not greater than or equal our threshold, we will send the pipeline to a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-fail">Fail Step</a> with the appropriate error message. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.fail_step.FailStep">FailStep</a> SageMaker’s SDK documentation for more information.</p>
<div class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.fail_step <span class="im">import</span> FailStep</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>fail_step <span class="op">=</span> FailStep(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"fail"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    error_message<span class="op">=</span>Join(</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">" "</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Execution failed because the model's accuracy was lower than"</span>,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>            accuracy_threshold,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use a <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.conditions.ConditionGreaterThanOrEqualTo">ConditionGreaterThanOrEqualTo</a> condition to compare the model’s accuracy with the threshold. Look at the <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_building_pipeline.html#conditions">Conditions</a> section in the documentation for more information about the types of supported conditions.</p>
<div class="cell" data-execution_count="235">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> JsonGet</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.conditions <span class="im">import</span> ConditionGreaterThanOrEqualTo</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>condition <span class="op">=</span> ConditionGreaterThanOrEqualTo(</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    left<span class="op">=</span>JsonGet(</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        step_name<span class="op">=</span>evaluate_model_step.name,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        property_file<span class="op">=</span>evaluation_report,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        json_path<span class="op">=</span><span class="st">"metrics.accuracy.value"</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    right<span class="op">=</span>accuracy_threshold,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now define the Condition Step:</p>
<div class="cell" data-tags="[]" data-execution_count="236">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.condition_step <span class="im">import</span> ConditionStep</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step] <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE <span class="cf">else</span> [],</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline">Step 5 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="237">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>session3_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session3-pipeline"</span>,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>session3_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start the pipeline:</p>
<div class="cell" data-code="true" data-execution_count="238">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>session3_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignments-2" class="level3">
<h3 class="anchored" data-anchor-id="assignments-2">Assignments</h3>
<ul>
<li><p><span style="padding:4px; line-height:30px; background-color: #f2a68a; color: #000;"><strong>Assignment 3.1</strong></span> The evaluation script computes the accuracy of the model and exports it as part of the evaluation report. Extend the evaluation report by adding the precision and the recall of the model on each one of the classes.</p></li>
<li><p><span style="padding:4px; line-height:30px; background-color: #f2a68a; color: #000;"><strong>Assignment 3.2</strong></span> Extend the evaluation script to test the model on each island separately. The evaluation report should contain the accuracy of the model on each island and the overall accuracy.</p></li>
<li><p><span style="padding:4px; line-height:30px; background-color: #f2a68a; color: #000;"><strong>Assignment 3.3</strong></span> The Condition Step uses a hard-coded threshold value to determine if the model’s accuracy is good enough to proceed. Modify the code so the pipeline uses the accuracy of the latest registered model version as the threshold. We want to register a new model version only if its performance is better than the previous version we registered.</p></li>
<li><p><span style="padding:4px; line-height:30px; background-color: #f2a68a; color: #000;"><strong>Assignment 3.4</strong></span> The current pipeline uses either a Training Step or a Tuning Step to build a model. Modify the pipeline to use both steps at the same time. The evaluation script should evaluate the model coming from the Training Step and the best model coming from the Tuning Step and output the accuracy and location in S3 of the best model. You should modify the code to register the model assets specified in the evaluation report.</p></li>
<li><p><span style="padding:4px; line-height:30px; background-color: #f2a68a; color: #000;"><strong>Assignment 3.5</strong></span> Pipeline steps can encounter exceptions. In some cases, retrying can resolve these issues. For this assignment, configure the Processing Step so it automatically retries the step a maximum of 5 times if it encounters an <code>InternalServerError</code>. Check the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-retry-policy.html">Retry Policy for Pipeline Steps</a> documentation for more information.</p></li>
</ul>
</section>
</section>
<section id="session-4---deploying-models-and-serving-predictions" class="level2">
<h2 class="anchored" data-anchor-id="session-4---deploying-models-and-serving-predictions">Session 4 - Deploying Models and Serving Predictions</h2>
<p>In this session we’ll explore how to deploy a model to a SageMaker Endpoint and how to use a SageMaker Inference Pipeline to control the data that goes in and comes out of the endpoint.</p>
<p><a href="images/deployment.png" target="_blank"> <img src="images/deployment.png" alt="Deployment" style="max-width: 750px;"></a></p>
<p>Let’s start by defining the name of the endpoint where we’ll deploy the model and creating a constant pointing to the location where we’ll store the data that the endpoint will capture:</p>
<div class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.predictor <span class="im">import</span> Predictor</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>ENDPOINT <span class="op">=</span> <span class="st">"penguins-endpoint"</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>DATA_CAPTURE_DESTINATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-capture"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="step-1---deploying-model-from-registry" class="level3">
<h3 class="anchored" data-anchor-id="step-1---deploying-model-from-registry">Step 1 - Deploying Model From Registry</h3>
<p>Let’s manually deploy the latest model from the Model Registry to an endpoint.</p>
<p>We want to query the list of approved models from the Model Registry and get the last one:</p>
<div class="cell" data-tags="[]" data-execution_count="240">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> sagemaker_client.list_model_packages(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    ModelPackageGroupName<span class="op">=</span>MODEL_PACKAGE_GROUP,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    ModelApprovalStatus<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    SortBy<span class="op">=</span><span class="st">"CreationTime"</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    MaxResults<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>package <span class="op">=</span> (</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    response[<span class="st">"ModelPackageSummaryList"</span>][<span class="dv">0</span>]</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response[<span class="st">"ModelPackageSummaryList"</span>]</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>package</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="240">
<pre><code>{'ModelPackageGroupName': 'penguins',
 'ModelPackageVersion': 77,
 'ModelPackageArn': 'arn:aws:sagemaker:us-east-1:325223348818:model-package/penguins/77',
 'CreationTime': datetime.datetime(2023, 11, 3, 11, 30, 21, 903000, tzinfo=tzlocal()),
 'ModelPackageStatus': 'Completed',
 'ModelApprovalStatus': 'Approved'}</code></pre>
</div>
</div>
<p>We can now create a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model.html#sagemaker.model.ModelPackage">Model Package</a> using the ARN of the model from the Model Registry:</p>
<div class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker <span class="im">import</span> ModelPackage</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> package:</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    model_package <span class="op">=</span> ModelPackage(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        model_package_arn<span class="op">=</span>package[<span class="st">"ModelPackageArn"</span>],</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now deploy the model to an endpoint.</p>
<p>Here is an overview of the three components of an Endpoint:</p>
<p><a href="images/endpoint-components.png" target="_blank"> <img src="images/endpoint-components.png" alt="An overview of the three components of an Endpoint" style="max-width: 750px;"></a></p>
<div class="cell" data-tags="[]" data-execution_count="242">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>model_package.deploy(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT, </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    initial_instance_count<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After deploying the model, we can test the endpoint to make sure it works.</p>
<p>Each line of the payload we’ll send to the endpoint contains the information of a penguin. Notice the model expects data that’s already transformed. We can’t provide the original data from our dataset because the model we registered will not work with it.</p>
<p>The endpoint will return the predictions for each of these lines.</p>
<div class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="st">0.6569590202313976,-1.0813829646495108,1.2097102831892812,0.9226343641317372,1.0,0.0,0.0</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="st">-0.7751048801481084,0.8822689351285553,-1.2168066120762704,0.9226343641317372,0.0,1.0,0.0</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="st">-0.837387834894918,0.3386660813829646,-0.26237731892812,-1.92351941317372,0.0,0.0,1.0</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s send the payload to the endpoint and print its response:</p>
<div class="cell" data-tags="[]" data-execution_count="244">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(endpoint_name<span class="op">=</span>ENDPOINT)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Species: </span><span class="sc">{</span>np<span class="sc">.</span>argmax(response[<span class="st">'predictions'</span>], axis<span class="op">=</span><span class="dv">1</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
<p>After testing the endpoint, we need to ensure we delete it:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="245">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>predictor.delete_endpoint()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Deploying the model we trained directly to an endpoint doesn’t lets us control the data that goes in and comes out of the endpoint. The TensorFlow model we trained requires transformed data, which makes it useless to other applications:</p>
<p><a href="images/prediction-service.png" target="_blank"> <img src="images/prediction-service.png" alt="Prediction service" style="max-width: 750px;"></a></p>
<p>Fortunately, we can create an Inference Pipeline using SageMaker to control the data that goes in and comes out of the endpoint.</p>
<p>Our inference pipeline will have three components:</p>
<ol type="1">
<li>A preprocessing transformer that will transform the input data into the format the model expects.</li>
<li>The TensorFlow model we trained.</li>
<li>A postprocessing transformer that will transform the output of the model into a human-readable format.</li>
</ol>
<p><a href="images/inference-pipeline.png" target="_blank"> <img src="images/inference-pipeline.png" alt="Inference pipeline" style="max-width: 750px;"></a></p>
<p>We want our endpoint to handle unprocessed data in CSV and JSON format and return the penguin’s species. Here is an example of the payload input we want the endpoint to support:</p>
<pre class="{json}"><code>{
    "island": "Biscoe",
    "culmen_length_mm": 48.6,
    "culmen_depth_mm": 16.0,
    "flipper_length_mm": 230.0,
    "body_mass_g": 5800.0,
}</code></pre>
<p>And here is an example of the output we’d like to get from the endpoint:</p>
<pre class="{json}"><code>{
    "prediction": "Adelie",
    "confidence": 0.802672
}</code></pre>
</section>
<section id="step-2---creating-the-preprocessing-script-1" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-preprocessing-script-1">Step 2 - Creating the Preprocessing Script</h3>
<p>The first component of our inference pipeline will transform the input data into the format the model expects. We’ll use the Scikit-Learn transformer we saved when we split and transformed the data. To deploy this component as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the input data, and returns the output in the format the TensorFlow model expects.</p>
<div id="preprocessing-component" class="cell" data-tags="[]" data-execution_count="246">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>preprocessing_component.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a><span class="im">import</span> os</span>
<span id="cb67-2"><a href="#cb67-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="im">import</span> json</span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="im">import</span> joblib</span>
<span id="cb67-5"><a href="#cb67-5"></a></span>
<span id="cb67-6"><a href="#cb67-6"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb67-7"><a href="#cb67-7"></a></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="cf">try</span>:</span>
<span id="cb67-9"><a href="#cb67-9"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> encoders, worker</span>
<span id="cb67-10"><a href="#cb67-10"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb67-11"><a href="#cb67-11"></a>    <span class="co"># We don't have access to the `worker` instance when testing locally.</span></span>
<span id="cb67-12"><a href="#cb67-12"></a>    <span class="co"># We'll set it to None so we can change the way functions create</span></span>
<span id="cb67-13"><a href="#cb67-13"></a>    <span class="co"># a response.</span></span>
<span id="cb67-14"><a href="#cb67-14"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb67-15"><a href="#cb67-15"></a></span>
<span id="cb67-16"><a href="#cb67-16"></a></span>
<span id="cb67-17"><a href="#cb67-17"></a>TARGET_COLUMN <span class="op">=</span> <span class="st">"species"</span></span>
<span id="cb67-18"><a href="#cb67-18"></a>FEATURE_COLUMNS <span class="op">=</span> [</span>
<span id="cb67-19"><a href="#cb67-19"></a>    <span class="st">"island"</span>,</span>
<span id="cb67-20"><a href="#cb67-20"></a>    <span class="st">"culmen_length_mm"</span>,</span>
<span id="cb67-21"><a href="#cb67-21"></a>    <span class="st">"culmen_depth_mm"</span>,</span>
<span id="cb67-22"><a href="#cb67-22"></a>    <span class="st">"flipper_length_mm"</span>,</span>
<span id="cb67-23"><a href="#cb67-23"></a>    <span class="st">"body_mass_g"</span>,</span>
<span id="cb67-24"><a href="#cb67-24"></a>    <span class="st">"sex"</span>,</span>
<span id="cb67-25"><a href="#cb67-25"></a>]</span>
<span id="cb67-26"><a href="#cb67-26"></a></span>
<span id="cb67-27"><a href="#cb67-27"></a></span>
<span id="cb67-28"><a href="#cb67-28"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb67-29"><a href="#cb67-29"></a>    <span class="co">"""</span></span>
<span id="cb67-30"><a href="#cb67-30"></a><span class="co">    Deserializes the model that will be used in this container.</span></span>
<span id="cb67-31"><a href="#cb67-31"></a><span class="co">    """</span></span>
<span id="cb67-32"><a href="#cb67-32"></a></span>
<span id="cb67-33"><a href="#cb67-33"></a>    <span class="cf">return</span> joblib.load(os.path.join(model_dir, <span class="st">"features.joblib"</span>))</span>
<span id="cb67-34"><a href="#cb67-34"></a>    </span>
<span id="cb67-35"><a href="#cb67-35"></a></span>
<span id="cb67-36"><a href="#cb67-36"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb67-37"><a href="#cb67-37"></a>    <span class="co">"""</span></span>
<span id="cb67-38"><a href="#cb67-38"></a><span class="co">    Parses the input payload and creates a Pandas DataFrame.</span></span>
<span id="cb67-39"><a href="#cb67-39"></a></span>
<span id="cb67-40"><a href="#cb67-40"></a><span class="co">    This function will check whether the target column is present in the</span></span>
<span id="cb67-41"><a href="#cb67-41"></a><span class="co">    input data, and will remove it.</span></span>
<span id="cb67-42"><a href="#cb67-42"></a><span class="co">    """</span></span>
<span id="cb67-43"><a href="#cb67-43"></a></span>
<span id="cb67-44"><a href="#cb67-44"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb67-45"><a href="#cb67-45"></a>        df <span class="op">=</span> pd.read_csv(StringIO(input_data), header<span class="op">=</span><span class="va">None</span>, skipinitialspace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb67-46"><a href="#cb67-46"></a></span>
<span id="cb67-47"><a href="#cb67-47"></a>        <span class="cf">if</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="bu">len</span>(FEATURE_COLUMNS) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb67-48"><a href="#cb67-48"></a>            df <span class="op">=</span> df.drop(df.columns[<span class="dv">0</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb67-49"><a href="#cb67-49"></a></span>
<span id="cb67-50"><a href="#cb67-50"></a>        df.columns <span class="op">=</span> FEATURE_COLUMNS</span>
<span id="cb67-51"><a href="#cb67-51"></a>        <span class="cf">return</span> df</span>
<span id="cb67-52"><a href="#cb67-52"></a></span>
<span id="cb67-53"><a href="#cb67-53"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb67-54"><a href="#cb67-54"></a>        df <span class="op">=</span> pd.DataFrame([json.loads(input_data)])</span>
<span id="cb67-55"><a href="#cb67-55"></a></span>
<span id="cb67-56"><a href="#cb67-56"></a>        <span class="cf">if</span> <span class="st">"species"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb67-57"><a href="#cb67-57"></a>            df <span class="op">=</span> df.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb67-58"><a href="#cb67-58"></a></span>
<span id="cb67-59"><a href="#cb67-59"></a>        <span class="cf">return</span> df</span>
<span id="cb67-60"><a href="#cb67-60"></a></span>
<span id="cb67-61"><a href="#cb67-61"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported!"</span>)</span>
<span id="cb67-62"><a href="#cb67-62"></a></span>
<span id="cb67-63"><a href="#cb67-63"></a></span>
<span id="cb67-64"><a href="#cb67-64"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb67-65"><a href="#cb67-65"></a>    <span class="co">"""</span></span>
<span id="cb67-66"><a href="#cb67-66"></a><span class="co">    Preprocess the input using the transformer.</span></span>
<span id="cb67-67"><a href="#cb67-67"></a><span class="co">    """</span></span>
<span id="cb67-68"><a href="#cb67-68"></a></span>
<span id="cb67-69"><a href="#cb67-69"></a>    <span class="cf">try</span>:</span>
<span id="cb67-70"><a href="#cb67-70"></a>        response <span class="op">=</span> model.transform(input_data)</span>
<span id="cb67-71"><a href="#cb67-71"></a>        <span class="cf">return</span> response</span>
<span id="cb67-72"><a href="#cb67-72"></a>    <span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="cb67-73"><a href="#cb67-73"></a>        <span class="bu">print</span>(<span class="st">"Error transforming the input data"</span>, e)</span>
<span id="cb67-74"><a href="#cb67-74"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb67-75"><a href="#cb67-75"></a></span>
<span id="cb67-76"><a href="#cb67-76"></a></span>
<span id="cb67-77"><a href="#cb67-77"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb67-78"><a href="#cb67-78"></a>    <span class="co">"""</span></span>
<span id="cb67-79"><a href="#cb67-79"></a><span class="co">    Formats the prediction output to generate a response.</span></span>
<span id="cb67-80"><a href="#cb67-80"></a></span>
<span id="cb67-81"><a href="#cb67-81"></a><span class="co">    The default accept/content-type between containers for serial inference</span></span>
<span id="cb67-82"><a href="#cb67-82"></a><span class="co">    is JSON. Since this model will preceed a TensorFlow model, we want to</span></span>
<span id="cb67-83"><a href="#cb67-83"></a><span class="co">    return a JSON object following TensorFlow's input requirements.</span></span>
<span id="cb67-84"><a href="#cb67-84"></a><span class="co">    """</span></span>
<span id="cb67-85"><a href="#cb67-85"></a></span>
<span id="cb67-86"><a href="#cb67-86"></a>    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb67-87"><a href="#cb67-87"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"There was an error transforming the input data"</span>)</span>
<span id="cb67-88"><a href="#cb67-88"></a></span>
<span id="cb67-89"><a href="#cb67-89"></a>    instances <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> prediction.tolist()]</span>
<span id="cb67-90"><a href="#cb67-90"></a>    response <span class="op">=</span> {<span class="st">"instances"</span>: instances}</span>
<span id="cb67-91"><a href="#cb67-91"></a>    <span class="cf">return</span> (</span>
<span id="cb67-92"><a href="#cb67-92"></a>        worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept)</span>
<span id="cb67-93"><a href="#cb67-93"></a>        <span class="cf">if</span> worker</span>
<span id="cb67-94"><a href="#cb67-94"></a>        <span class="cf">else</span> (response, accept)</span>
<span id="cb67-95"><a href="#cb67-95"></a>    )</span>
<span id="cb67-96"><a href="#cb67-96"></a></span>
<span id="cb67-97"><a href="#cb67-97"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"</span><span class="sc">{</span>accept<span class="sc">}</span><span class="ss"> accept type is not supported."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div class="cell" data-tags="[]" data-execution_count="247">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> preprocessing_component <span class="im">import</span> input_fn, predict_fn, output_fn, model_fn</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        tar.extractall(path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_drops_target_column_if_present():</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="st">    Adelie, Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_drops_target_column_if_present():</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"species"</span>: <span class="st">"Adelie"</span>, </span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_works_without_target_column():</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_works_without_target_column():</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_raises_exception_if_prediction_is_none():</span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>):</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a>        output_fn(<span class="va">None</span>, <span class="st">"application/json"</span>)</span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_returns_tensorflow_ready_input():</span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> np.array([</span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">0</span>] <span class="op">==</span> {</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instances"</span>: [</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>            [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>            [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>] <span class="op">==</span> <span class="st">"application/json"</span></span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_transforms_data(directory):</span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(<span class="bu">str</span>(directory))</span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(df, model)</span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">type</span>(response) <span class="kw">is</span> np.ndarray</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_none_if_invalid_input(directory):</span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a><span class="st">    Invalid, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(<span class="bu">str</span>(directory))</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> predict_fn(df, model) <span class="kw">is</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-3---creating-the-postprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-the-postprocessing-script">Step 3 - Creating the Postprocessing Script</h3>
<p>The final component of our inference pipeline will transform the output from the model into a human-readable format. We’ll use the Scikit-Learn target transformer we saved when we split and transformed the data. To deploy this component as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the output from the model, and returns a human-readable format.</p>
<div id="postprocessing-component" class="cell" data-tags="[]" data-execution_count="248">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>postprocessing_component.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a><span class="im">import</span> os</span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="im">import</span> json</span>
<span id="cb69-4"><a href="#cb69-4"></a><span class="im">import</span> joblib</span>
<span id="cb69-5"><a href="#cb69-5"></a></span>
<span id="cb69-6"><a href="#cb69-6"></a></span>
<span id="cb69-7"><a href="#cb69-7"></a><span class="cf">try</span>:</span>
<span id="cb69-8"><a href="#cb69-8"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> encoders, worker</span>
<span id="cb69-9"><a href="#cb69-9"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb69-10"><a href="#cb69-10"></a>    <span class="co"># We don't have access to the `worker` instance when testing locally.</span></span>
<span id="cb69-11"><a href="#cb69-11"></a>    <span class="co"># We'll set it to None so we can change the way functions create</span></span>
<span id="cb69-12"><a href="#cb69-12"></a>    <span class="co"># a response.</span></span>
<span id="cb69-13"><a href="#cb69-13"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb69-14"><a href="#cb69-14"></a></span>
<span id="cb69-15"><a href="#cb69-15"></a></span>
<span id="cb69-16"><a href="#cb69-16"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb69-17"><a href="#cb69-17"></a>    <span class="co">"""</span></span>
<span id="cb69-18"><a href="#cb69-18"></a><span class="co">    Deserializes the target model and returns the list of fitted categories.</span></span>
<span id="cb69-19"><a href="#cb69-19"></a><span class="co">    """</span></span>
<span id="cb69-20"><a href="#cb69-20"></a></span>
<span id="cb69-21"><a href="#cb69-21"></a>    model <span class="op">=</span> joblib.load(os.path.join(model_dir, <span class="st">"target.joblib"</span>))</span>
<span id="cb69-22"><a href="#cb69-22"></a>    <span class="cf">return</span> model.named_transformers_[<span class="st">"species"</span>].categories_[<span class="dv">0</span>]</span>
<span id="cb69-23"><a href="#cb69-23"></a></span>
<span id="cb69-24"><a href="#cb69-24"></a></span>
<span id="cb69-25"><a href="#cb69-25"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb69-26"><a href="#cb69-26"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb69-27"><a href="#cb69-27"></a>        predictions <span class="op">=</span> json.loads(input_data)[<span class="st">"predictions"</span>]</span>
<span id="cb69-28"><a href="#cb69-28"></a>        <span class="cf">return</span> predictions</span>
<span id="cb69-29"><a href="#cb69-29"></a>    </span>
<span id="cb69-30"><a href="#cb69-30"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported.!"</span>)</span>
<span id="cb69-31"><a href="#cb69-31"></a></span>
<span id="cb69-32"><a href="#cb69-32"></a></span>
<span id="cb69-33"><a href="#cb69-33"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb69-34"><a href="#cb69-34"></a>    <span class="co">"""</span></span>
<span id="cb69-35"><a href="#cb69-35"></a><span class="co">    Transforms the prediction into its corresponding category.</span></span>
<span id="cb69-36"><a href="#cb69-36"></a><span class="co">    """</span></span>
<span id="cb69-37"><a href="#cb69-37"></a>    predictions <span class="op">=</span> np.argmax(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb69-38"><a href="#cb69-38"></a>    confidence <span class="op">=</span> np.<span class="bu">max</span>(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb69-39"><a href="#cb69-39"></a>    <span class="cf">return</span> [</span>
<span id="cb69-40"><a href="#cb69-40"></a>        (model[prediction], confidence)</span>
<span id="cb69-41"><a href="#cb69-41"></a>        <span class="cf">for</span> confidence, prediction <span class="kw">in</span> <span class="bu">zip</span>(confidence, predictions)</span>
<span id="cb69-42"><a href="#cb69-42"></a>    ]</span>
<span id="cb69-43"><a href="#cb69-43"></a></span>
<span id="cb69-44"><a href="#cb69-44"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb69-45"><a href="#cb69-45"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb69-46"><a href="#cb69-46"></a>        <span class="cf">return</span> (</span>
<span id="cb69-47"><a href="#cb69-47"></a>            worker.Response(encoders.encode(prediction, accept), mimetype<span class="op">=</span>accept)</span>
<span id="cb69-48"><a href="#cb69-48"></a>            <span class="cf">if</span> worker</span>
<span id="cb69-49"><a href="#cb69-49"></a>            <span class="cf">else</span> (prediction, accept)</span>
<span id="cb69-50"><a href="#cb69-50"></a>        )</span>
<span id="cb69-51"><a href="#cb69-51"></a></span>
<span id="cb69-52"><a href="#cb69-52"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb69-53"><a href="#cb69-53"></a>        response <span class="op">=</span> []</span>
<span id="cb69-54"><a href="#cb69-54"></a>        <span class="cf">for</span> p, c <span class="kw">in</span> prediction:</span>
<span id="cb69-55"><a href="#cb69-55"></a>            response.append({<span class="st">"prediction"</span>: p, <span class="st">"confidence"</span>: c})</span>
<span id="cb69-56"><a href="#cb69-56"></a></span>
<span id="cb69-57"><a href="#cb69-57"></a>        <span class="co"># If there's only one prediction, we'll return it</span></span>
<span id="cb69-58"><a href="#cb69-58"></a>        <span class="co"># as a single object.</span></span>
<span id="cb69-59"><a href="#cb69-59"></a>        <span class="cf">if</span> <span class="bu">len</span>(response) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb69-60"><a href="#cb69-60"></a>            response <span class="op">=</span> response[<span class="dv">0</span>]</span>
<span id="cb69-61"><a href="#cb69-61"></a></span>
<span id="cb69-62"><a href="#cb69-62"></a>        <span class="cf">return</span> (</span>
<span id="cb69-63"><a href="#cb69-63"></a>            worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept)</span>
<span id="cb69-64"><a href="#cb69-64"></a>            <span class="cf">if</span> worker</span>
<span id="cb69-65"><a href="#cb69-65"></a>            <span class="cf">else</span> (response, accept)</span>
<span id="cb69-66"><a href="#cb69-66"></a>        )</span>
<span id="cb69-67"><a href="#cb69-67"></a></span>
<span id="cb69-68"><a href="#cb69-68"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"</span><span class="sc">{</span>accept<span class="sc">}</span><span class="ss"> accept type is not supported."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div class="cell" data-tags="[]" data-execution_count="249">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> postprocessing_component <span class="im">import</span> predict_fn, output_fn</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_prediction_as_first_column():</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> [</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.6</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>], </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>],</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.7</span>]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> [<span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span>, <span class="st">"Chinstrap"</span>]</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(input_data, categories)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response <span class="op">==</span> [</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Adelie"</span>, <span class="fl">0.6</span>),</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Gentoo"</span>, <span class="fl">0.8</span>),</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Chinstrap"</span>, <span class="fl">0.7</span>)</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_does_not_return_array_if_single_prediction():</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> [(<span class="st">"Adelie"</span>, <span class="fl">0.6</span>)]</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    response, _ <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Adelie"</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_returns_array_if_multiple_predictions():</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> [(<span class="st">"Adelie"</span>, <span class="fl">0.6</span>), (<span class="st">"Gentoo"</span>, <span class="fl">0.8</span>)]</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    response, _ <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(response) <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">0</span>][<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Adelie"</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>][<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Gentoo"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-4---setting-up-the-inference-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-the-inference-pipeline">Step 4 - Setting up the Inference Pipeline</h3>
<p>We can now create a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/pipeline.html#sagemaker.pipeline.PipelineModel">PipelineModel</a> to define our inference pipeline.</p>
<p>We’ll use the model we generated from the first step of the pipeline as the input to the first and last components of the inference pipeline. This <code>model.tar.gz</code> file contains the two transformers we need to preprocess and postprocess the data. Let’s create a variable with the URI to this file:</p>
<div class="cell" data-execution_count="250">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>transformation_pipeline_model <span class="op">=</span> Join(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"/"</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span>[</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model.tar.gz"</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the first component of the inference pipeline. It will preprocess the data before sending it to the TensorFlow model:</p>
<div class="cell" data-execution_count="251">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.model <span class="im">import</span> SKLearnModel</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>preprocessing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"preprocessing_component.py"</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="bu">str</span>(INFERENCE_CODE_FOLDER),</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the last component of the inference pipeline. It will postprocess the output from the TensorFlow model before sending it back to the user:</p>
<div class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>post_processing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"postprocessing_component.py"</span>,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="bu">str</span>(INFERENCE_CODE_FOLDER),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the inference pipeline using the three models:</p>
<div class="cell" data-tags="[]" data-execution_count="253">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.pipeline <span class="im">import</span> PipelineModel</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>pipeline_model <span class="op">=</span> PipelineModel(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"inference-model"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[preprocessing_model, tensorflow_model, post_processing_model],</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---registering-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-5---registering-the-model">Step 5 - Registering the Model</h3>
<p>We’ll modify the pipeline to register the Pipeline Model in the Model Registry. We’ll use a different group name to keep Pipeline Models separate.</p>
<div class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>PIPELINE_MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"pipeline"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now register the model. Notice that we will register the model with “PendingManualApproval” status. This means that we’ll need to manually approve the model before it can be deployed to an endpoint. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry-version.html">Register a Model Version</a> for more information about model registration.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="255">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"register"</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"register-model"</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.register(</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        approval_status<span class="op">=</span><span class="st">"PendingManualApproval"</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        inference_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        transform_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        domain<span class="op">=</span><span class="st">"MACHINE_LEARNING"</span>,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"CLASSIFICATION"</span>,</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        framework<span class="op">=</span><span class="st">"TENSORFLOW"</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---modifying-the-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-6---modifying-the-condition-step">Step 6 - Modifying the Condition Step</h3>
<p>Since we modified the registration step, we also need to modify the Condition Step to use the new registration:</p>
<div class="cell" data-tags="[]" data-execution_count="256">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step] <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE <span class="cf">else</span> [],</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-7---creating-the-pipeline">Step 7 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="257">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>session4_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session4-pipeline"</span>,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>session4_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start the pipeline:</p>
<div class="cell" data-code="true" data-execution_count="258">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>session4_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---creating-the-lambda-function" class="level3">
<h3 class="anchored" data-anchor-id="step-8---creating-the-lambda-function">Step 8 - Creating the Lambda Function</h3>
<p>We will use <a href="https://aws.amazon.com/pm/eventbridge/">Amazon EventBridge</a> to trigger a Lambda function that will deploy the model whenever its status changes from “PendingManualApproval” to “Approved.” Let’s start by writing the Lambda function to take the model information and create a new endpoint.</p>
<p>We’ll enable <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-data-capture.html">Data Capture</a> as part of the endpoint configuration. With Data Capture we can record the inputs and outputs of the endpoint to use them later for monitoring the model:</p>
<ul>
<li><code>InitialSamplingPercentage</code> represents the percentage of traffic that we want to capture.</li>
<li><code>DestinationS3Uri</code> specifies the S3 location where we want to store the captured data.</li>
</ul>
<div class="cell" data-execution_count="259">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>sagemaker <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lambda_handler(event, context):</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    model_package_arn <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelPackageArn"</span>]</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    approval_status <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelApprovalStatus"</span>]</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Model: </span><span class="sc">{</span>model_package_arn<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Approval status: </span><span class="sc">{</span>approval_status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We only want to deploy the approved models</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> approval_status <span class="op">!=</span> <span class="st">"Approved"</span>:</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> {</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"message"</span>: <span class="st">"Skipping deployment."</span>,</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"approval_status"</span>: approval_status,</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(response)</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"statusCode"</span>: <span class="dv">200</span>,</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"body"</span>: json.dumps(response)</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>        }    </span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    endpoint_name <span class="op">=</span> os.environ[<span class="st">"ENDPOINT"</span>]</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    data_capture_destination <span class="op">=</span> os.environ[<span class="st">"DATA_CAPTURE_DESTINATION"</span>]</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> time.strftime(<span class="st">"%m</span><span class="sc">%d</span><span class="st">%H%M%S"</span>, time.localtime())</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-model-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    endpoint_config_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-config-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    sagemaker.create_model(</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>        ModelName<span class="op">=</span>model_name, </span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>        ExecutionRoleArn<span class="op">=</span>role, </span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>        Containers<span class="op">=</span>[{</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelPackageName"</span>: model_package_arn</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>        }] </span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>    sagemaker.create_endpoint_config(</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>        EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>        ProductionVariants<span class="op">=</span>[{</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelName"</span>: model_name,</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InstanceType"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialVariantWeight"</span>: <span class="dv">1</span>,</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialInstanceCount"</span>: <span class="dv">1</span>,</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"VariantName"</span>: <span class="st">"AllTraffic"</span>,</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>        }],</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We can enable Data Capture to record the inputs and outputs</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># of the endpoint to use them later for monitoring the model. </span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>        DataCaptureConfig<span class="op">=</span>{</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"EnableCapture"</span>: <span class="va">True</span>,</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialSamplingPercentage"</span>: <span class="dv">100</span>,</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DestinationS3Uri"</span>: data_capture_destination,</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CaptureOptions"</span>: [</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"CaptureMode"</span>: <span class="st">"Input"</span></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"CaptureMode"</span>: <span class="st">"Output"</span></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CaptureContentTypeHeader"</span>: {</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>                <span class="st">"CsvContentTypes"</span>: [</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text/csv"</span>,</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/octect-stream"</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>                <span class="st">"JsonContentTypes"</span>: [</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/json"</span>,</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application/octect-stream"</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker.list_endpoints(NameContains<span class="op">=</span>endpoint_name, MaxResults<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(response[<span class="st">"Endpoints"</span>]) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the endpoint doesn't exist, let's create it.</span></span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>        sagemaker.create_endpoint(</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a>            EndpointName<span class="op">=</span>endpoint_name, </span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the endpoint already exist, let's update it with the</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new configuration.</span></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>        sagemaker.update_endpoint(</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>            EndpointName<span class="op">=</span>endpoint_name, </span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">"statusCode"</span>: <span class="dv">200</span>,</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body"</span>: json.dumps(<span class="st">"Endpoint deployed successfully"</span>)</span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting code/lambda.py</code></pre>
</div>
</div>
<p>We need to ensure our Lambda function has permission to interact with SageMaker, so let’s create a new role and then create the lambda function.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="260">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>lambda_role_name <span class="op">=</span> <span class="st">"lambda-deployment-role"</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>lambda_role_arn <span class="op">=</span> <span class="va">None</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.create_role(</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        AssumeRolePolicyDocument<span class="op">=</span>json.dumps(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Version"</span>: <span class="st">"2012-10-17"</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Statement"</span>: [</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Effect"</span>: <span class="st">"Allow"</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Principal"</span>: {</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Service"</span>: [<span class="st">"lambda.amazonaws.com"</span>, <span class="st">"events.amazonaws.com"</span>]</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Action"</span>: <span class="st">"sts:AssumeRole"</span>,</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>        Description<span class="op">=</span><span class="st">"Lambda Endpoint Deployment"</span>,</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>,</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"</span>,</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Role "</span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss">" created with ARN "</span><span class="sc">{</span>lambda_role_arn<span class="sc">}</span><span class="ss">".'</span>)</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> iam_client.exceptions.EntityAlreadyExistsException:</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.get_role(RoleName<span class="op">=</span>lambda_role_name)</span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Role "</span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss">" already exists with ARN "</span><span class="sc">{</span>lambda_role_arn<span class="sc">}</span><span class="ss">".'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the Lambda function:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="261">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.lambda_helper <span class="im">import</span> Lambda</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>deploy_lambda_fn <span class="op">=</span> Lambda(</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    function_name<span class="op">=</span><span class="st">"deploy_fn"</span>,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    execution_role_arn<span class="op">=</span>lambda_role_arn,</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    script<span class="op">=</span><span class="bu">str</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"lambda.py"</span>),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">=</span><span class="st">"lambda.lambda_handler"</span>,</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    timeout<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    session<span class="op">=</span>sagemaker_session,</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    runtime<span class="op">=</span><span class="st">"python3.11"</span>,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span>{</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Variables"</span>: {</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ENDPOINT"</span>: ENDPOINT,</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DATA_CAPTURE_DESTINATION"</span>: DATA_CAPTURE_DESTINATION,</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ROLE"</span>: role,</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>lambda_response <span class="op">=</span> deploy_lambda_fn.upsert()</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>lambda_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-9---setting-up-eventbridge" class="level3">
<h3 class="anchored" data-anchor-id="step-9---setting-up-eventbridge">Step 9 - Setting Up EventBridge</h3>
<p>We can now create an EventBridge rule that triggers the deployment process whenever a model approval status becomes “Approved”. To do this, let’s define the event pattern that will trigger the deployment process:</p>
<div class="cell" data-execution_count="262">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>event_pattern <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="ss">  "source": ["aws.sagemaker"],</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail-type": ["SageMaker Model Package State Change"],</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail": </span><span class="ch">{{</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelPackageGroupName": ["</span><span class="sc">{</span>PIPELINE_MODEL_PACKAGE_GROUP<span class="sc">}</span><span class="ss">"],</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelApprovalStatus": ["Approved"]</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="ch">}}</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the EventBridge rule:</p>
<div class="cell" data-execution_count="263">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>events_client <span class="op">=</span> boto3.client(<span class="st">"events"</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>rule_response <span class="op">=</span> events_client.put_rule(</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    Name<span class="op">=</span><span class="st">"PipelineModelApprovedRule"</span>,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    EventPattern<span class="op">=</span>event_pattern,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    State<span class="op">=</span><span class="st">"ENABLED"</span>,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    RoleArn<span class="op">=</span>role,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to define the target of the rule. The target will trigger whenever the rule matches an event. In this case, we want to trigger the Lambda function we created before:</p>
<div class="cell" data-tags="[]" data-execution_count="264">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> events_client.put_targets(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    Rule<span class="op">=</span><span class="st">"PipelineModelApprovedRule"</span>,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    Targets<span class="op">=</span>[</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Id"</span>: <span class="st">"1"</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Arn"</span>: lambda_response[<span class="st">"FunctionArn"</span>],</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we need to give the Lambda function permission to be triggered by the EventBridge rule:</p>
<div class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>lambda_client <span class="op">=</span> boto3.client(<span class="st">"lambda"</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> lambda_client.add_permission(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>        Action<span class="op">=</span><span class="st">"lambda:InvokeFunction"</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        FunctionName<span class="op">=</span>lambda_response[<span class="st">"FunctionName"</span>],</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>        Principal<span class="op">=</span><span class="st">"events.amazonaws.com"</span>,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        SourceArn<span class="op">=</span>rule_response[<span class="st">"RuleArn"</span>],</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>        StatementId<span class="op">=</span><span class="st">"EventBridge"</span>,</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> lambda_client.exceptions.ResourceConflictException <span class="im">as</span> e:</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Function "</span><span class="sc">{</span>lambda_response[<span class="st">"FunctionName"</span>]<span class="sc">}</span><span class="ss">" already has permissions.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function "deploy_fn" already has permissions.</code></pre>
</div>
</div>
</section>
<section id="step-10---testing-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-10---testing-the-endpoint">Step 10 - Testing the Endpoint</h3>
<p>Let’s now test the endpoint we deployed automatically with the pipeline. We will use the function to create a predictor with a JSON encoder and decoder.</p>
<div class="cell" data-tags="[]" data-execution_count="266">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> CSVSerializer</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT, </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>CSVSerializer(),</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> data.iloc[:<span class="dv">3</span>].to_csv(header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Payload:</span><span class="ch">\n</span><span class="sc">{</span>payload<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Payload:
Torgersen,39.1,18.7,181.0,3750.0,MALE
Torgersen,39.5,17.4,186.0,3800.0,FEMALE
Torgersen,40.3,18.0,195.0,3250.0,FEMALE

An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
<p>Let’s now test the endpoint by sending a JSON payload:</p>
<div class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> JSONSerializer</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> {</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"island"</span>: <span class="st">"Biscoe"</span>,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_length_mm"</span>: <span class="fl">48.6</span>,</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_depth_mm"</span>: <span class="fl">16.0</span>,</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flipper_length_mm"</span>: <span class="fl">230.0</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"body_mass_g"</span>: <span class="fl">5800.0</span>,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT, </span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>JSONSerializer(),</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(sample)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.loads(response.decode(<span class="st">"utf-8"</span>)))</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
<p>And now let’s send the same payload but return the prediction in CSV format:</p>
<div class="cell" data-execution_count="268">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(sample, initial_args<span class="op">=</span>{<span class="st">"Accept"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
<p>Let’s delete the endpoint:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="269">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>predictor.delete_endpoint()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignments-3" class="level3">
<h3 class="anchored" data-anchor-id="assignments-3">Assignments</h3>
<ul>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 4.1</strong></span> Every Endpoint has an invocation URL you can use to generate predictions with the model from outside AWS. As part of this assignment, write a simple Python script that will run on your local computer and run a few samples through the Endpoint. You will need your AWS access key and secret to connect to the Endpoint.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 4.2</strong></span> We can use model variants to perform A/B testing between a new model and an old model. Create a function that given the ARN of two models in the Model Registry deploys them to an Endpoint as separate variants. Each variant should receive 50% of the traffic. Write another function that invokes the endpoint by default, but allows the caller to invoke a specific variant if they want to.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 4.3</strong></span> We can use SageMaker Model Shadow Deployments to create shadow variants to validate a new model version before promoting it to production. Write a function that given the ARN of a model in the Model Registry, updates an Endpoint and deploys the model as a shadow variant. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-shadow-deployment.html">Shadow variants</a> for more information about this topic. Send some traffic to the Endpoint and compare the results from the main model with its shadow variant.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 4.4</strong></span> SageMaker supports auto scaling your models. Auto scaling dynamically adjusts the number of instances provisioned for a model in response to changes in the workload. For this assignment, define a target-tracking scaling policy for a variant of your Endpoint and use the <code>SageMakerVariantInvocationsPerInstance</code> metric. <code>SageMakerVariantInvocationsPerInstance</code> is the average number of times per minute that the variant is invoked. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/endpoint-auto-scaling.html">Automatically Scale Amazon SageMaker Models</a> for more information about auto scaling models.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 4.5</strong></span> Modify the SageMaker Pipeline by adding a Lambda Step that will deploy the model directly as part of the pipeline. You won’t need to set up Event Bridge anymore because your pipeline will automatically deploy the model.</p></li>
</ul>
</section>
</section>
<section id="session-5---data-distribution-shifts-and-model-monitoring" class="level2">
<h2 class="anchored" data-anchor-id="session-5---data-distribution-shifts-and-model-monitoring">Session 5 - Data Distribution Shifts And Model Monitoring</h2>
<p>In this session we’ll set up a monitoring process to analyze the quality of the data our endpoint receives and the endpoint predictions. For this, we need to check the data received by the endpoint, generate ground truth labels, and compare them with a baseline performance.</p>
<p><a href="images/monitoring.png" target="_blank"> <img src="images/monitoring.png" alt="Monitoring" style="max-width: 750px;"></a></p>
<p>To enable this functionality, we need a couple of steps:</p>
<ol type="1">
<li>Create baselines we can use to compare against real-time traffic.</li>
<li>Set up a schedule to continuously evaluate and compare against the baselines.</li>
</ol>
<p>Check <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_monitoring.html">Amazon SageMaker Model Monitor</a> for a brief explanation of how to use SageMaker’s Model Monitoring functionality. <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor.html">Monitor models for data and model quality, bias, and explainability</a> is a much more extensive guide to monitoring in Amazon SageMaker.</p>
<p>Let’s start by defining three variables we’ll use throughout the session:</p>
<div class="cell" data-execution_count="270">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/groundtruth"</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-quality"</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>MODEL_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/model-quality"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="step-1---generating-data-quality-baseline" class="level3">
<h3 class="anchored" data-anchor-id="step-1---generating-data-quality-baseline">Step 1 - Generating Data Quality Baseline</h3>
<p>Let’s start by configuring a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> to compute the general statistics of the data we used to build our model.</p>
<p>We can configure the instance that will run the quality check using the <a href="https://sagemaker.readthedocs.io/en/v2.73.0/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.check_job_config.CheckJobConfig">CheckJobConfig</a> class, and we can use the <code>DataQualityCheckConfig</code> class to configure the job.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="271">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> (</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    QualityCheckStep,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    DataQualityCheckConfig,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.check_job_config <span class="im">import</span> CheckJobConfig</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor.dataset_format <span class="im">import</span> DatasetFormat</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>data_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-data-quality-baseline"</span>,</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    check_job_config<span class="op">=</span>CheckJobConfig(</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>pipeline_session,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    quality_check_config<span class="op">=</span>DataQualityCheckConfig(</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train-baseline"</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">True</span>, output_columns_position<span class="op">=</span><span class="st">"START"</span>),</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>DATA_QUALITY_LOCATION,</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---generating-test-predictions" class="level3">
<h3 class="anchored" data-anchor-id="step-2---generating-test-predictions">Step 2 - Generating Test Predictions</h3>
<p>To create a baseline to compare the model performance, we must create predictions for the test set and compare the model’s metrics with the model performance on production data. We can do this by running a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html">Batch Transform Job</a> to predict every sample from the test set. We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> as part of the pipeline to run this job. This Batch Transform Job will run every sample from the training dataset through the model so we can compute the baseline metrics.</p>
<p>The Transform Step requires a model to generate predictions, so we need a Model Step that creates a model:</p>
<div class="cell" data-code="true" data-execution_count="272">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.model_step <span class="im">import</span> ModelStep</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>create_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"create-model"</span>,</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.create(instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>]),</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s configure the Batch Transform Job using an instance of the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/transformer.html">Transformer</a> class:</p>
<div class="cell" data-execution_count="273">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.transformer <span class="im">import</span> Transformer</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>transformer <span class="op">=</span> Transformer(</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span>create_model_step.properties.ModelName,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span><span class="st">"MultiRecord"</span>,</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    accept<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    assemble_with<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/transform"</span>,</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now set up the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> using the transformer we configured before.</p>
<p>Notice the following:</p>
<ul>
<li>We’ll generate predictions for the baseline output that we generated when we split and transformed the data. This baseline is the same data we used to test the model, but we saved it in its original format before transforming it.</li>
<li>The output of this Batch Transform Job will have two fields. The first one will be the ground truth label, and the second one will be the prediction of the model.</li>
</ul>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="274">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TransformStep</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>generate_test_predictions_step <span class="op">=</span> (</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    TransformStep(</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"generate-test-predictions"</span>,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>        step_args<span class="op">=</span>transformer.transform(</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We will use the baseline set we generated when we split the data.</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>            <span class="co"># This set corresponds to the test split before the transformation step.</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"test-baseline"</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>            ].S3Output.S3Uri,</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>            join_source<span class="op">=</span><span class="st">"Input"</span>,</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>            split_type<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>            content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We want to output the first and the second to last field from</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the joint set. The first field corresponds to the groundtruth,</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># and the second to last field corresponds to the prediction.</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">#</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Here is an example of the data the Transform Job will generate</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># after joining the input with the output from the model:</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">#</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Gentoo,39.1,18.7,181.0,3750.0,MALE,Gentoo,0.52</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">#</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Notice how the first field is the groundtruth coming from the</span></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># test set. The second to last field is the prediction coming the</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># model.</span></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>            output_filter<span class="op">=</span><span class="st">"$[0,-2]"</span>,</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>        cache_config<span class="op">=</span>cache_config,</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---generating-model-quality-baseline" class="level3">
<h3 class="anchored" data-anchor-id="step-3---generating-model-quality-baseline">Step 3 - Generating Model Quality Baseline</h3>
<p>Let’s now configure the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> and feed it the data we generated in the Transform Step. This step will automatically compute the performance metrics of the model on the test set:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="275">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> ModelQualityCheckConfig</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>model_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-model-quality-baseline"</span>,</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    check_job_config<span class="op">=</span>CheckJobConfig(</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>pipeline_session,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    quality_check_config<span class="op">=</span>ModelQualityCheckConfig(</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We are going to use the output of the Transform Step to generate</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the model quality baseline.</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span>generate_test_predictions_step.properties.TransformOutput.S3OutputPath,</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to specify the problem type and the fields where the prediction</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and groundtruth are so the process knows how to interpret the results.</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>        problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Since the data doesn't have headers, SageMaker will autocreate headers for it.</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># _c0 corresponds to the first column, and _c1 corresponds to the second column.</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>        ground_truth_attribute<span class="op">=</span><span class="st">"_c0"</span>,</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"_c1"</span>,</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>MODEL_QUALITY_LOCATION,</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-model-metrics" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-model-metrics">Step 4 - Setting up Model Metrics</h3>
<p>We can configure a new set of <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">ModelMetrics</a> using the results of the Data and Model Quality Steps. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-quality-clarify-baseline-lifecycle.html#pipelines-quality-clarify-baseline-evolution">Baseline and model version lifecycle and evolution with SageMaker Pipelines</a> for an explanation of how SageMaker uses the <code>DriftCheckBaselines</code>.</p>
<div class="cell" data-tags="[]" data-execution_count="276">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.drift_check_baselines <span class="im">import</span> DriftCheckBaselines</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>drift_check_baselines <span class="op">=</span> DriftCheckBaselines(</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---modifying-the-registration-step" class="level3">
<h3 class="anchored" data-anchor-id="step-5---modifying-the-registration-step">Step 5 - Modifying the Registration Step</h3>
<p>Since we want to register the model using the new metrics, we need to modify the Registration Step to use the new metrics:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="277">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"register"</span>,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    display_name<span class="op">=</span><span class="st">"register-model"</span>,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.register(</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>        drift_check_baselines<span class="op">=</span>drift_check_baselines,</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        approval_status<span class="op">=</span><span class="st">"PendingManualApproval"</span>,</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>        content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>        response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>        inference_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>        transform_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>        domain<span class="op">=</span><span class="st">"MACHINE_LEARNING"</span>,</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>        task<span class="op">=</span><span class="st">"CLASSIFICATION"</span>,</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>        framework<span class="op">=</span><span class="st">"TENSORFLOW"</span>,</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>        framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---modifying-the-condition-step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-6---modifying-the-condition-step-1">Step 6 - Modifying the Condition Step</h3>
<p>Since we modified the registration step and added a few more steps, we need to modify the Condition Step. Now, we want to generate the test predictions and compute the model quality baseline if the condition is successful:</p>
<div class="cell" data-tags="[]" data-execution_count="278">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        create_model_step,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        generate_test_predictions_step,</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>        model_quality_baseline_step,</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        register_model_step,</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> [],</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-7---creating-the-pipeline-1">Step 7 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="279">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>session5_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session5-pipeline"</span>,</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        data_quality_baseline_step,</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>session5_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now start the pipeline:</p>
<div class="cell" data-code="true" data-execution_count="441">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>session5_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---checking-constraints-and-statistics" class="level3">
<h3 class="anchored" data-anchor-id="step-8---checking-constraints-and-statistics">Step 8 - Checking Constraints and Statistics</h3>
<p>Our pipeline generated data baseline statistics and constraints. We can take a look at what these values look like by downloading them from S3. You need to wait for the pipeline to finish running before these files are available.</p>
<p>Here are the data quality statistics:</p>
<div class="cell" data-execution_count="347">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Downloader</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>        S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response[<span class="st">"features"</span>][<span class="dv">1</span>], indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "name": "island",
  "inferred_type": "String",
  "string_statistics": {
    "common": {
      "num_present": 235,
      "num_missing": 0
    },
    "distinct_count": 3.0,
    "distribution": {
      "categorical": {
        "buckets": [
          {
            "value": "Dream",
            "count": 86
          },
          {
            "value": "Torgersen",
            "count": 34
          },
          {
            "value": "Biscoe",
            "count": 115
          }
        ]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>Here are the data quality constraints:</p>
<div class="cell" data-execution_count="498">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>))</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "version": 0.0,
  "features": [
    {
      "name": "species",
      "inferred_type": "String",
      "completeness": 1.0,
      "string_constraints": {
        "domains": [
          "Adelie",
          "Chinstrap",
          "Gentoo"
        ]
      }
    },
    {
      "name": "island",
      "inferred_type": "String",
      "completeness": 1.0,
      "string_constraints": {
        "domains": [
          "Dream",
          "Torgersen",
          "Biscoe"
        ]
      }
    },
    {
      "name": "culmen_length_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "culmen_depth_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "flipper_length_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "body_mass_g",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "sex",
      "inferred_type": "String",
      "completeness": 1.0,
      "string_constraints": {
        "domains": [
          "FEMALE",
          "MALE"
        ]
      }
    }
  ],
  "monitoring_config": {
    "evaluate_constraints": "Enabled",
    "emit_metrics": "Enabled",
    "datatype_check_threshold": 1.0,
    "domain_content_threshold": 1.0,
    "distribution_constraints": {
      "perform_comparison": "Enabled",
      "comparison_threshold": 0.1,
      "comparison_method": "Robust",
      "categorical_comparison_threshold": 0.1,
      "categorical_drift_method": "LInfinity"
    }
  }
}</code></pre>
</div>
</div>
<p>And here are the model quality constraints:</p>
<div class="cell" data-execution_count="499">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>))</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "version": 0.0,
  "multiclass_classification_constraints": {
    "accuracy": {
      "threshold": 0.88,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_recall": {
      "threshold": 0.88,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_precision": {
      "threshold": 0.8940711462450592,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f0_5": {
      "threshold": 0.8763227513227512,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f1": {
      "threshold": 0.8677740863787375,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f2": {
      "threshold": 0.8722000126911604,
      "comparison_operator": "LessThanThreshold"
    }
  }
}</code></pre>
</div>
</div>
</section>
<section id="step-9---generating-fake-traffic" class="level3">
<h3 class="anchored" data-anchor-id="step-9---generating-fake-traffic">Step 9 - Generating Fake Traffic</h3>
<p>To test the monitoring functionality, we need to generate traffic to the endpoint. To generate traffic, we will send every sample from the dataset to the endpoint to simulate real prediction requests:</p>
<div class="cell" data-code="true" data-execution_count="542">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> JSONSerializer</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> penguins.drop([<span class="st">"species"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.dropna()</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>JSONSerializer(),</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> data.iterrows():</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>        predictor.predict(row.to_dict(), inference_id<span class="op">=</span><span class="bu">str</span>(index))</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(e)</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the location where the endpoint stores the captured data, download a file, and display its content. It may take a few minutes for the first few files to show up in S3.</p>
<p>These files contain the data captured by the endpoint in a SageMaker-specific JSON-line format. Each inference request is captured in a single line in the <code>jsonl</code> file. The line contains both the input and output merged together:</p>
<div class="cell" data-tags="[]" data-execution_count="543">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> S3Downloader.<span class="bu">list</span>(DATA_CAPTURE_DESTINATION)[:<span class="dv">3</span>]</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(files):</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> S3Downloader.read_file(files[<span class="dv">0</span>])</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(json.loads(lines.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)[<span class="dv">0</span>]), indent<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "captureData": {
    "endpointInput": {
      "observedContentType": "application/json",
      "mode": "INPUT",
      "data": "{\"island\": \"Torgersen\", \"culmen_length_mm\": 39.1, \"culmen_depth_mm\": 18.7, \"flipper_length_mm\": 181.0, \"body_mass_g\": 3750.0, \"sex\": \"MALE\"}",
      "encoding": "JSON"
    },
    "endpointOutput": {
      "observedContentType": "application/json",
      "mode": "OUTPUT",
      "data": "{\"prediction\": \"Adelie\", \"confidence\": 0.962092221}",
      "encoding": "JSON"
    }
  },
  "eventMetadata": {
    "eventId": "952c2752-29a4-4c45-b4f3-02298278ec65",
    "inferenceId": "0",
    "inferenceTime": "2023-11-09T22:21:44Z"
  },
  "eventVersion": "0"
}</code></pre>
</div>
</div>
<p>These files contain the data captured by the endpoint in a SageMaker-specific JSON-line format. Each inference request is captured in a single line in the <code>jsonl</code> file. The line contains both the input and output merged together:</p>
</section>
<section id="step-10---generating-fake-labels" class="level3">
<h3 class="anchored" data-anchor-id="step-10---generating-fake-labels">Step 10 - Generating Fake Labels</h3>
<p>To test the performance of the model, we need to label the samples captured by the endpoint. We can simulate the labeling process by generating a random label for every sample. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-merge.html">Ingest Ground Truth Labels and Merge Them With Predictions</a> for more information about this.</p>
<div class="cell" data-code="true" data-execution_count="544">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Uploader</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> inference_id <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data)):</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    random.seed(inference_id)</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    records.append(json.dumps({</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"groundTruthData"</span>: {</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"data"</span>: random.choice([<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>]),</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"encoding"</span>: <span class="st">"CSV"</span>,</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eventMetadata"</span>: {</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"eventId"</span>: <span class="bu">str</span>(inference_id),</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eventVersion"</span>: <span class="st">"0"</span>,</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>groundtruth_payload <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(records)</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>upload_time <span class="op">=</span> datetime.utcnow()</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>GROUND_TRUTH_LOCATION<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>upload_time<span class="sc">:</span><span class="op">%</span>Y<span class="op">/%</span>m<span class="op">/%</span>d<span class="op">/%</span>H<span class="op">/%</span>M<span class="op">%</span>S<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>S3Uploader.upload_string_as_file_body(groundtruth_payload, uri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-11---preparing-monitoring-functions" class="level3">
<h3 class="anchored" data-anchor-id="step-11---preparing-monitoring-functions">Step 11 - Preparing Monitoring Functions</h3>
<p>Let’s create a few functions that will help us work with monitoring schedules later on:</p>
<div class="cell" data-tags="[]" data-execution_count="485">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> MonitoringExecution</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_monitoring_schedules(endpoint_name):</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    schedules <span class="op">=</span> []</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.list_monitoring_schedules(EndpointName<span class="op">=</span>endpoint_name)[</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MonitoringScheduleSummaries"</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> response:</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>        schedule <span class="op">=</span> {</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Name"</span>: name,</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Type"</span>: item[<span class="st">"MonitoringType"</span>],</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>            MonitoringScheduleName<span class="op">=</span>name</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        schedule[<span class="st">"Status"</span>] <span class="op">=</span> description[<span class="st">"MonitoringScheduleStatus"</span>]</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        last_execution_status <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MonitoringExecutionStatus"</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>        schedule[<span class="st">"Last Execution Status"</span>] <span class="op">=</span> last_execution_status</span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>        schedule[<span class="st">"Last Execution Date"</span>] <span class="op">=</span> <span class="bu">str</span>(description[<span class="st">"LastMonitoringExecutionSummary"</span>][<span class="st">"LastModifiedTime"</span>])</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> last_execution_status <span class="op">==</span> <span class="st">"Failed"</span>:</span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>            schedule[<span class="st">"Failure Reason"</span>] <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][</span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">"FailureReason"</span></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> last_execution_status <span class="op">==</span> <span class="st">"CompletedWithViolations"</span>:</span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a>            processing_job_arn <span class="op">=</span> description[<span class="st">"LastMonitoringExecutionSummary"</span>][</span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ProcessingJobArn"</span></span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>            execution <span class="op">=</span> MonitoringExecution.from_processing_arn(</span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>                sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>                processing_job_arn<span class="op">=</span>processing_job_arn,</span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a>            execution_destination <span class="op">=</span> execution.output.destination</span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a>            violations_filepath <span class="op">=</span> os.path.join(</span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a>                execution_destination, <span class="st">"constraint_violations.json"</span></span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a>            violations <span class="op">=</span> json.loads(S3Downloader.read_file(violations_filepath))[</span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">"violations"</span></span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a>            schedule[<span class="st">"Violations"</span>] <span class="op">=</span> violations</span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a>        schedules.append(schedule)</span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> schedules</span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_monitoring_schedule(endpoint_name, monitoring_type):</span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb117-60"><a href="#cb117-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-61"><a href="#cb117-61" aria-hidden="true" tabindex="-1"></a>    schedules <span class="op">=</span> describe_monitoring_schedules(endpoint_name)</span>
<span id="cb117-62"><a href="#cb117-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> schedule <span class="kw">in</span> schedules:</span>
<span id="cb117-63"><a href="#cb117-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> schedule[<span class="st">"Type"</span>] <span class="op">==</span> monitoring_type:</span>
<span id="cb117-64"><a href="#cb117-64" aria-hidden="true" tabindex="-1"></a>            found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb117-65"><a href="#cb117-65" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(json.dumps(schedule, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb117-66"><a href="#cb117-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-67"><a href="#cb117-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> found:</span>
<span id="cb117-68"><a href="#cb117-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"There's no </span><span class="sc">{</span>monitoring_type<span class="sc">}</span><span class="ss"> Monitoring Schedule."</span>)</span>
<span id="cb117-69"><a href="#cb117-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-70"><a href="#cb117-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-71"><a href="#cb117-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_data_monitoring_schedule(endpoint_name):</span>
<span id="cb117-72"><a href="#cb117-72" aria-hidden="true" tabindex="-1"></a>    describe_monitoring_schedule(endpoint_name, <span class="st">"DataQuality"</span>)</span>
<span id="cb117-73"><a href="#cb117-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-74"><a href="#cb117-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-75"><a href="#cb117-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> describe_model_monitoring_schedule(endpoint_name):</span>
<span id="cb117-76"><a href="#cb117-76" aria-hidden="true" tabindex="-1"></a>    describe_monitoring_schedule(endpoint_name, <span class="st">"ModelQuality"</span>)</span>
<span id="cb117-77"><a href="#cb117-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-78"><a href="#cb117-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-79"><a href="#cb117-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_monitoring_schedule(endpoint_name, monitoring_type):</span>
<span id="cb117-80"><a href="#cb117-80" aria-hidden="true" tabindex="-1"></a>    attempts <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb117-81"><a href="#cb117-81" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> <span class="va">False</span></span>
<span id="cb117-82"><a href="#cb117-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-83"><a href="#cb117-83" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.list_monitoring_schedules(EndpointName<span class="op">=</span>endpoint_name)[</span>
<span id="cb117-84"><a href="#cb117-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MonitoringScheduleSummaries"</span></span>
<span id="cb117-85"><a href="#cb117-85" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb117-86"><a href="#cb117-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> response:</span>
<span id="cb117-87"><a href="#cb117-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> item[<span class="st">"MonitoringType"</span>] <span class="op">==</span> monitoring_type:</span>
<span id="cb117-88"><a href="#cb117-88" aria-hidden="true" tabindex="-1"></a>            found <span class="op">=</span> <span class="va">True</span></span>
<span id="cb117-89"><a href="#cb117-89" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb117-90"><a href="#cb117-90" aria-hidden="true" tabindex="-1"></a>            summary <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb117-91"><a href="#cb117-91" aria-hidden="true" tabindex="-1"></a>                MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb117-92"><a href="#cb117-92" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb117-93"><a href="#cb117-93" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> summary[<span class="st">"MonitoringScheduleStatus"</span>]</span>
<span id="cb117-94"><a href="#cb117-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-95"><a href="#cb117-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> status <span class="op">==</span> <span class="st">"Scheduled"</span> <span class="kw">and</span> <span class="st">"LastMonitoringExecutionSummary"</span> <span class="kw">in</span> summary <span class="kw">and</span> <span class="st">"MonitoringExecutionStatus"</span> <span class="kw">in</span> summary[<span class="st">"LastMonitoringExecutionSummary"</span>]:</span>
<span id="cb117-96"><a href="#cb117-96" aria-hidden="true" tabindex="-1"></a>                status <span class="op">=</span> summary[<span class="st">"LastMonitoringExecutionSummary"</span>][<span class="st">"MonitoringExecutionStatus"</span>]</span>
<span id="cb117-97"><a href="#cb117-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-98"><a href="#cb117-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> status <span class="kw">in</span> (<span class="st">"Pending"</span>, <span class="st">"InProgress"</span>) <span class="kw">and</span> attempts <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb117-99"><a href="#cb117-99" aria-hidden="true" tabindex="-1"></a>                attempts <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb117-100"><a href="#cb117-100" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(</span>
<span id="cb117-101"><a href="#cb117-101" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Monitoring schedule status: </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">. Waiting for it to finish."</span></span>
<span id="cb117-102"><a href="#cb117-102" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb117-103"><a href="#cb117-103" aria-hidden="true" tabindex="-1"></a>                sleep(<span class="dv">30</span>)</span>
<span id="cb117-104"><a href="#cb117-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-105"><a href="#cb117-105" aria-hidden="true" tabindex="-1"></a>                status <span class="op">=</span> sagemaker_client.describe_monitoring_schedule(</span>
<span id="cb117-106"><a href="#cb117-106" aria-hidden="true" tabindex="-1"></a>                    MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb117-107"><a href="#cb117-107" aria-hidden="true" tabindex="-1"></a>                )[<span class="st">"MonitoringScheduleStatus"</span>]</span>
<span id="cb117-108"><a href="#cb117-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-109"><a href="#cb117-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> status <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"Pending"</span>, <span class="st">"InProgress"</span>):</span>
<span id="cb117-110"><a href="#cb117-110" aria-hidden="true" tabindex="-1"></a>                sagemaker_client.delete_monitoring_schedule(</span>
<span id="cb117-111"><a href="#cb117-111" aria-hidden="true" tabindex="-1"></a>                    MonitoringScheduleName<span class="op">=</span>item[<span class="st">"MonitoringScheduleName"</span>]</span>
<span id="cb117-112"><a href="#cb117-112" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb117-113"><a href="#cb117-113" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Monitoring schedule deleted."</span>)</span>
<span id="cb117-114"><a href="#cb117-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb117-115"><a href="#cb117-115" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Waiting for monitoring schedule timed out"</span>)</span>
<span id="cb117-116"><a href="#cb117-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-117"><a href="#cb117-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> found:</span>
<span id="cb117-118"><a href="#cb117-118" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"There's no </span><span class="sc">{</span>monitoring_type<span class="sc">}</span><span class="ss"> Monitoring Schedule."</span>)</span>
<span id="cb117-119"><a href="#cb117-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-120"><a href="#cb117-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-121"><a href="#cb117-121" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_data_monitoring_schedule(endpoint_name):</span>
<span id="cb117-122"><a href="#cb117-122" aria-hidden="true" tabindex="-1"></a>    delete_monitoring_schedule(endpoint_name, <span class="st">"DataQuality"</span>)</span>
<span id="cb117-123"><a href="#cb117-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-124"><a href="#cb117-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-125"><a href="#cb117-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_model_monitoring_schedule(endpoint_name):</span>
<span id="cb117-126"><a href="#cb117-126" aria-hidden="true" tabindex="-1"></a>    delete_monitoring_schedule(endpoint_name, <span class="st">"ModelQuality"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-12---setting-up-data-monitoring-job" class="level3">
<h3 class="anchored" data-anchor-id="step-12---setting-up-data-monitoring-job">Step 12 - Setting Up Data Monitoring Job</h3>
<p>SageMaker looks for violations in the data captured by the endpoint. By default, it combines the input data with the endpoint output and compares the result with the baseline we generated. If we let SageMaker do this, we will get a few violations, for example an “extra column check” violation because the field <code>confidence</code> doesn’t exist in the baseline data.</p>
<p>We can fix these violations by creating a preprocessing script configuring the data we want the monitoring job to use. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-pre-and-post-processing.html">Preprocessing and Postprocessing</a> for more information about how to configure these scripts.</p>
<p>Let’s define the name of the preprocessing script:</p>
<div class="cell" data-tags="[]" data-execution_count="481">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_PREPROCESSOR <span class="op">=</span> <span class="st">"data_quality_preprocessor.py"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now define the preprocessing script. Notice that this script will return the input data the endpoint receives with a new <code>species</code> column containing the prediction of the model:</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="538">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_handler(inference_record):</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.loads(inference_record.endpoint_input.data)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    output_data <span class="op">=</span> json.loads(inference_record.endpoint_output.data)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> input_data</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    response[<span class="st">"species"</span>] <span class="op">=</span> output_data[<span class="st">"prediction"</span>]</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The `response` variable contains the data that we want the</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># monitoring job to use to compare with the baseline.</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The monitoring schedule expects an S3 location pointing to the preprocessing script. Let’s upload the script to the default bucket.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="280">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> boto3.Session().resource(<span class="st">"s3"</span>).Bucket(config[<span class="st">"session"</span>].default_bucket())</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>prefix <span class="op">=</span> <span class="st">"penguins/monitoring"</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>bucket.Object(os.path.join(prefix, DATA_QUALITY_PREPROCESSOR)).upload_file(</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">str</span>(CODE_FOLDER <span class="op">/</span> DATA_QUALITY_PREPROCESSOR)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>data_quality_preprocessor <span class="op">=</span> (</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"s3://</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>join(bucket.name, prefix, DATA_QUALITY_PREPROCESSOR)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now set up the Data Quality Monitoring Job using the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.DefaultModelMonitor">DefaultModelMonitor</a> class. Notice how we specify the <code>record_preprocessor_script</code> using the S3 location where we uploaded our script.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="540">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> CronExpressionGenerator, DefaultModelMonitor</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>data_monitor <span class="op">=</span> DefaultModelMonitor(</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">3600</span>,</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>data_monitor.create_monitoring_schedule(</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-data-monitoring-schedule"</span>,</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    endpoint_input<span class="op">=</span>ENDPOINT,</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    record_preprocessor_script<span class="op">=</span>data_quality_preprocessor,</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    statistics<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span>,</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>    output_s3_uri<span class="op">=</span>DATA_QUALITY_LOCATION,</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the results of the monitoring job by looking at whether it generated any violations:</p>
<div class="cell" data-tags="[]" data-execution_count="545">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>describe_data_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "Name": "penguins-data-monitoring-schedule",
  "Type": "DataQuality",
  "Status": "Scheduled",
  "Last Execution Status": "Failed",
  "Last Execution Date": "2023-11-10 15:01:08.656000-05:00",
  "Failure Reason": "Job inputs had no data"
}</code></pre>
</div>
</div>
</section>
<section id="step-13---setting-up-model-monitoring-job" class="level3">
<h3 class="anchored" data-anchor-id="step-13---setting-up-model-monitoring-job">Step 13 - Setting up Model Monitoring Job</h3>
<p>To set up a Model Quality Monitoring Job, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.ModelQualityMonitor">ModelQualityMonitor</a> class. The <a href="https://sagemaker.readthedocs.io/en/v2.24.2/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.EndpointInput">EndpointInput</a> instance configures the attribute the monitoring job should use to determine the prediction from the model.</p>
<p>Check <a href="https://sagemaker-examples.readthedocs.io/en/latest/sagemaker_model_monitor/model_quality/model_quality_churn_sdk.html">Amazon SageMaker Model Quality Monitor</a> for a complete tutorial on how to run a Model Monitoring Job in SageMaker.</p>
<p>We can now start the Model Quality Monitoring Job:</p>
<div class="cell" data-code="true" data-execution_count="460">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> ModelQualityMonitor, EndpointInput</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>model_monitor <span class="op">=</span> ModelQualityMonitor(</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">1800</span>,</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>model_monitor.create_monitoring_schedule(</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-model-monitoring-schedule"</span>,</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    endpoint_input <span class="op">=</span> EndpointInput(</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>        endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        destination<span class="op">=</span><span class="st">"/opt/ml/processing/input_data"</span>,</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>    ground_truth_input<span class="op">=</span>GROUND_TRUTH_LOCATION,</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>    output_s3_uri<span class="op">=</span>MODEL_QUALITY_LOCATION,</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the results of the monitoring job by looking at whether it generated any violations.</p>
<p>Here is an example of a few violations generated by the monitoring job:</p>
<pre><code>{
  "Name": "penguins-model-monitoring-schedule",
  "Type": "ModelQuality",
  "Status": "Scheduled",
  "Last Execution Status": "CompletedWithViolations",
  "Last Execution Date": "2023-11-10 07:15:38.870000-05:00",
  "Violations": [
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedF2 with 0.35599535646931135 +/- 0.014588104295968964 was LessThanThreshold '0.8722000126911604'",
      "metric_name": "weightedF2"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric accuracy with 0.3691860465116279 +/- 0.01318589816003266 was LessThanThreshold '0.88'",
      "metric_name": "accuracy"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedRecall with 0.3691860465116279 +/- 0.013185898160032667 was LessThanThreshold '0.88'",
      "metric_name": "weightedRecall"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedPrecision with 0.3723930543404764 +/- 0.026898711106593986 was LessThanThreshold '0.8940711462450592'",
      "metric_name": "weightedPrecision"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedF1 with 0.34565734045211405 +/- 0.01766811466802452 was LessThanThreshold '0.8677740863787375'",
      "metric_name": "weightedF1"
    }
  ]
}</code></pre>
<div class="cell" data-tags="[]" data-execution_count="493">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>describe_model_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "Name": "penguins-model-monitoring-schedule",
  "Type": "ModelQuality",
  "Status": "Scheduled",
  "Last Execution Status": "CompletedWithViolations",
  "Last Execution Date": "2023-11-10 07:15:38.870000-05:00",
  "Violations": [
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedF2 with 0.35599535646931135 +/- 0.014588104295968964 was LessThanThreshold '0.8722000126911604'",
      "metric_name": "weightedF2"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric accuracy with 0.3691860465116279 +/- 0.01318589816003266 was LessThanThreshold '0.88'",
      "metric_name": "accuracy"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedRecall with 0.3691860465116279 +/- 0.013185898160032667 was LessThanThreshold '0.88'",
      "metric_name": "weightedRecall"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedPrecision with 0.3723930543404764 +/- 0.026898711106593986 was LessThanThreshold '0.8940711462450592'",
      "metric_name": "weightedPrecision"
    },
    {
      "constraint_check_type": "LessThanThreshold",
      "description": "Metric weightedF1 with 0.34565734045211405 +/- 0.01766811466802452 was LessThanThreshold '0.8677740863787375'",
      "metric_name": "weightedF1"
    }
  ]
}</code></pre>
</div>
</div>
</section>
<section id="step-14---tearing-down-resources" class="level3">
<h3 class="anchored" data-anchor-id="step-14---tearing-down-resources">Step 14 - Tearing Down Resources</h3>
<p>The following code will stop the monitoring jobs and delete the endpoint.</p>
<div class="cell" data-tags="[]" data-code="true" data-execution_count="546">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>delete_data_monitoring_schedule(ENDPOINT)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>delete_model_monitoring_schedule(ENDPOINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s delete the endpoint:</p>
<div class="cell" data-code="true">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>predictor.delete_endpoint()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="assignments-4" class="level3">
<h3 class="anchored" data-anchor-id="assignments-4">Assignments</h3>
<ul>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 5.1</strong></span> You can visualize the results of your monitoring jobs in Amazon SageMaker Studio. Go to your endpoint, and visit the Data quality and Model quality tabs. View the details of your monitoring jobs, and create a few charts to explore the baseline and the captured values for any metric that the monitoring job calculates.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 5.2</strong></span> The QualityCheck Step runs a processing job to compute baseline statistics and constraints from the input dataset. We configured the pipeline to generate the initial baselines every time it runs. Modify the code to prevent the pipeline from registering a new version of the model if the dataset violates the baseline of the previous model version. You can configure the QualityCheck Step to accomplish this.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 5.3</strong></span> We are generating predictions for the test set twice during the execution of our pipeline. First, during the Evaluation Step, and then using a Transform Step in anticipation of generating the baseline to monitor the model. Modify the Evaluation Step so it reuses the model performance computed by the QualityCheck Step instead of generating predictions again.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 5.4</strong></span> <a href="https://evidentlyai.com/">Evidently AI</a> is an open-source Machine Learning observability platform that you can use to evaluate, test, and monitor models. For this assignment, integrate the endpoint we built with Evidently AI to use its capabilities to monitor the model.</p></li>
<li><p><span style="padding:4px; background-color: #f2a68a; color: #000;"><strong>Assignment 5.5</strong></span> Instead of running the entire pipeline from start to finish, sometimes you may only need to iterate over particular steps. SageMaker Pipelines supports <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-selective-ex.html">Selective Execution for Pipeline Steps</a>. In this assignment you will use Selective Execution to only run one specific step of the pipeline. <a href="https://aws.amazon.com/blogs/machine-learning/unlocking-efficiency-harnessing-the-power-of-selective-execution-in-amazon-sagemaker-pipelines/">Unlocking efficiency: Harnessing the power of Selective Execution in Amazon SageMaker Pipelines</a> is a great article that explains this feature.</p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>